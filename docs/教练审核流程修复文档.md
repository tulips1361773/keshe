# æ•™ç»ƒå®¡æ ¸æµç¨‹ä¿®å¤æ–‡æ¡£

## é—®é¢˜æè¿°

### åŸå§‹é—®é¢˜
- **ç°è±¡**ï¼šæ•™ç»ƒå‘˜è´¦æˆ· `coach1234` åœ¨Djangoç®¡ç†åå°å®¡æ ¸é€šè¿‡åï¼Œä»ç„¶æ— æ³•ç™»å½•ï¼Œè¿”å›400é”™è¯¯
- **é”™è¯¯ä¿¡æ¯**ï¼š"æ•™ç»ƒå‘˜è´¦æˆ·å¾…å®¡æ ¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜"
- **å½±å“èŒƒå›´**ï¼šæ‰€æœ‰é€šè¿‡Djangoç®¡ç†åå°å®¡æ ¸çš„æ•™ç»ƒå‘˜ç”¨æˆ·

### æ ¹æœ¬åŸå› 
æ•™ç»ƒå‘˜ç™»å½•éœ€è¦åŒæ—¶æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š
1. `user.is_active = True`ï¼ˆè´¦æˆ·æ¿€æ´»ï¼‰
2. `user.is_active_member = True`ï¼ˆä¼šå‘˜æ¿€æ´»ï¼‰
3. `coach.status = 'approved'`ï¼ˆæ•™ç»ƒå®¡æ ¸é€šè¿‡ï¼‰

**é—®é¢˜æ‰€åœ¨**ï¼šåŸæœ‰çš„å®¡æ ¸æµç¨‹åªè®¾ç½®äº† `is_active = True`ï¼Œä½†æ²¡æœ‰è®¾ç½® `is_active_member = True`ï¼Œå¯¼è‡´ç™»å½•APIéªŒè¯å¤±è´¥ã€‚

## ä¿®å¤æ–¹æ¡ˆ

### 1. Djangoç®¡ç†åå°ä¿®å¤

**æ–‡ä»¶**ï¼š`accounts/admin.py`

**ä¿®å¤å‰**ï¼š
```python
# å¦‚æœå®¡æ ¸é€šè¿‡ï¼Œæ¿€æ´»ç”¨æˆ·è´¦æˆ·
if obj.status == 'approved':
    obj.user.is_active = True
    obj.user.save()
```

**ä¿®å¤å**ï¼š
```python
# å¦‚æœå®¡æ ¸é€šè¿‡ï¼Œæ¿€æ´»ç”¨æˆ·è´¦æˆ·å¹¶è®¾ç½®ä¼šå‘˜çŠ¶æ€
if obj.status == 'approved':
    obj.user.is_active = True
    obj.user.is_active_member = True  # å…³é”®ä¿®å¤ï¼šè®¾ç½®ä¼šå‘˜æ¿€æ´»çŠ¶æ€
    obj.user.save()
    
    # è®°å½•å®¡æ ¸æ—¥å¿—
    from django.contrib.admin.models import LogEntry, CHANGE
    from django.contrib.contenttypes.models import ContentType
    LogEntry.objects.log_action(
        user_id=request.user.id,
        content_type_id=ContentType.objects.get_for_model(obj.user).pk,
        object_id=obj.user.pk,
        object_repr=str(obj.user),
        action_flag=CHANGE,
        change_message=f'æ•™ç»ƒå®¡æ ¸é€šè¿‡ï¼Œæ¿€æ´»ç”¨æˆ·è´¦æˆ·å’Œä¼šå‘˜çŠ¶æ€'
    )
elif obj.status == 'rejected':
    # å¦‚æœå®¡æ ¸æ‹’ç»ï¼Œç¡®ä¿ç”¨æˆ·æ— æ³•ç™»å½•
    obj.user.is_active_member = False
    obj.user.save()
```

### 2. APIå®¡æ ¸æ¥å£ä¿®å¤

**æ–‡ä»¶**ï¼š`accounts/views.py`

**ä¿®å¤å‰**ï¼š
```python
# å¦‚æœå®¡æ ¸é€šè¿‡ï¼Œæ¿€æ´»ç”¨æˆ·è´¦æˆ·
if updated_coach.status == 'approved':
    updated_coach.user.is_active = True
    updated_coach.user.save()
```

**ä¿®å¤å**ï¼š
```python
# å¦‚æœå®¡æ ¸é€šè¿‡ï¼Œæ¿€æ´»ç”¨æˆ·è´¦æˆ·å¹¶è®¾ç½®ä¼šå‘˜çŠ¶æ€
if updated_coach.status == 'approved':
    updated_coach.user.is_active = True
    updated_coach.user.is_active_member = True  # å…³é”®ä¿®å¤ï¼šè®¾ç½®ä¼šå‘˜æ¿€æ´»çŠ¶æ€
    updated_coach.user.save()
elif updated_coach.status == 'rejected':
    # å¦‚æœå®¡æ ¸æ‹’ç»ï¼Œç¡®ä¿ç”¨æˆ·æ— æ³•ç™»å½•
    updated_coach.user.is_active_member = False
    updated_coach.user.save()
```

## éªŒè¯æµ‹è¯•

### æµ‹è¯•è„šæœ¬
åˆ›å»ºäº† `test_approval_fix.py` è„šæœ¬è¿›è¡Œå…¨é¢æµ‹è¯•ï¼ŒåŒ…æ‹¬ï¼š

1. **å®¡æ ¸é€šè¿‡æµç¨‹æµ‹è¯•**
   - åˆ›å»ºå¾…å®¡æ ¸æ•™ç»ƒ
   - æ¨¡æ‹Ÿç®¡ç†åå°å®¡æ ¸é€šè¿‡
   - éªŒè¯æ‰€æœ‰çŠ¶æ€å­—æ®µæ­£ç¡®è®¾ç½®

2. **ç™»å½•åŠŸèƒ½æµ‹è¯•**
   - éªŒè¯å®¡æ ¸é€šè¿‡åå¯ä»¥æ­£å¸¸ç™»å½•
   - éªŒè¯ç™»å½•APIçš„å®Œæ•´éªŒè¯é€»è¾‘

3. **å®¡æ ¸æ‹’ç»æµç¨‹æµ‹è¯•**
   - æ¨¡æ‹Ÿå®¡æ ¸æ‹’ç»
   - éªŒè¯ç”¨æˆ·æ— æ³•ç™»å½•

### æµ‹è¯•ç»“æœ
```
å®¡æ ¸é€šè¿‡æµç¨‹: âœ… é€šè¿‡
ç™»å½•åŠŸèƒ½: âœ… é€šè¿‡
å®¡æ ¸æ‹’ç»æµç¨‹: âœ… é€šè¿‡

ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼å®¡æ ¸æµç¨‹ä¿®å¤æˆåŠŸï¼
```

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰çŠ¶æ€
- `is_active = True`
- `is_active_member = False` âŒ
- `coach.status = 'approved'`
- **ç»“æœ**ï¼šç™»å½•å¤±è´¥ï¼Œè¿”å›400é”™è¯¯

### ä¿®å¤åçŠ¶æ€
- `is_active = True`
- `is_active_member = True` âœ…
- `coach.status = 'approved'`
- **ç»“æœ**ï¼šç™»å½•æˆåŠŸ

## é¢„é˜²æªæ–½

### 1. ä»£ç å±‚é¢
- âœ… **ç»Ÿä¸€å®¡æ ¸é€»è¾‘**ï¼šç¡®ä¿Djangoç®¡ç†åå°å’ŒAPIå®¡æ ¸ä½¿ç”¨ç›¸åŒçš„çŠ¶æ€è®¾ç½®é€»è¾‘
- âœ… **å®Œæ•´çŠ¶æ€ç®¡ç†**ï¼šå®¡æ ¸é€šè¿‡æ—¶åŒæ—¶è®¾ç½®æ‰€æœ‰å¿…è¦çš„çŠ¶æ€å­—æ®µ
- âœ… **å®¡æ ¸æ—¥å¿—è®°å½•**ï¼šè®°å½•è¯¦ç»†çš„å®¡æ ¸æ“ä½œæ—¥å¿—ï¼Œä¾¿äºé—®é¢˜è¿½è¸ª
- âœ… **æ‹’ç»æµç¨‹å¤„ç†**ï¼šå®¡æ ¸æ‹’ç»æ—¶æ­£ç¡®è®¾ç½®ç”¨æˆ·çŠ¶æ€

### 2. æµ‹è¯•å±‚é¢
- âœ… **è‡ªåŠ¨åŒ–æµ‹è¯•**ï¼šåˆ›å»ºå®Œæ•´çš„å®¡æ ¸æµç¨‹æµ‹è¯•è„šæœ¬
- âœ… **ç«¯åˆ°ç«¯æµ‹è¯•**ï¼šä»å®¡æ ¸åˆ°ç™»å½•çš„å®Œæ•´æµç¨‹éªŒè¯
- âœ… **è¾¹ç•Œæƒ…å†µæµ‹è¯•**ï¼šåŒ…æ‹¬å®¡æ ¸é€šè¿‡ã€æ‹’ç»ç­‰å„ç§æƒ…å†µ

### 3. æ–‡æ¡£å±‚é¢
- âœ… **ä¿®å¤æ–‡æ¡£**ï¼šè¯¦ç»†è®°å½•é—®é¢˜åŸå› å’Œè§£å†³æ–¹æ¡ˆ
- âœ… **æ“ä½œæŒ‡å—**ï¼šä¸ºç®¡ç†å‘˜æä¾›æ¸…æ™°çš„å®¡æ ¸æ“ä½œæŒ‡å¯¼
- âœ… **çŠ¶æ€è¯´æ˜**ï¼šæ˜ç¡®å„ä¸ªçŠ¶æ€å­—æ®µçš„å«ä¹‰å’Œä½œç”¨

## ç›¸å…³å­—æ®µè¯´æ˜

### Useræ¨¡å‹å…³é”®å­—æ®µ
- `is_active`ï¼šDjangoå†…ç½®å­—æ®µï¼Œæ§åˆ¶ç”¨æˆ·æ˜¯å¦å¯ä»¥ç™»å½•ç³»ç»Ÿ
- `is_active_member`ï¼šè‡ªå®šä¹‰å­—æ®µï¼Œæ§åˆ¶ç”¨æˆ·æ˜¯å¦ä¸ºæ´»è·ƒä¼šå‘˜
- `user_type`ï¼šç”¨æˆ·ç±»å‹ï¼ŒåŒ…æ‹¬å­¦å‘˜ã€æ•™ç»ƒå‘˜ã€ç®¡ç†å‘˜ç­‰

### Coachæ¨¡å‹å…³é”®å­—æ®µ
- `status`ï¼šæ•™ç»ƒå®¡æ ¸çŠ¶æ€ï¼ˆpending/approved/rejectedï¼‰
- `approved_by`ï¼šå®¡æ ¸äºº
- `approved_at`ï¼šå®¡æ ¸æ—¶é—´

### ç™»å½•éªŒè¯é€»è¾‘
```python
# æ•™ç»ƒå‘˜éœ€è¦é¢å¤–éªŒè¯ä¼šå‘˜çŠ¶æ€
if user.user_type == 'coach' and not user.is_active_member:
    return Response({
        'success': False,
        'message': 'æ•™ç»ƒå‘˜è´¦æˆ·å¾…å®¡æ ¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜'
    }, status=400)
```

## æ€»ç»“

è¿™æ¬¡ä¿®å¤è§£å†³äº†æ•™ç»ƒå‘˜å®¡æ ¸æµç¨‹ä¸­çš„å…³é”®é—®é¢˜ï¼Œç¡®ä¿ï¼š

1. **å®Œæ•´æ€§**ï¼šå®¡æ ¸é€šè¿‡æ—¶è®¾ç½®æ‰€æœ‰å¿…è¦çš„çŠ¶æ€å­—æ®µ
2. **ä¸€è‡´æ€§**ï¼šDjangoç®¡ç†åå°å’ŒAPIä½¿ç”¨ç›¸åŒçš„å®¡æ ¸é€»è¾‘
3. **å¯é æ€§**ï¼šé€šè¿‡è‡ªåŠ¨åŒ–æµ‹è¯•éªŒè¯ä¿®å¤æ•ˆæœ
4. **å¯ç»´æŠ¤æ€§**ï¼šè¯¦ç»†çš„æ–‡æ¡£å’Œæ—¥å¿—è®°å½•

é€šè¿‡è¿™æ¬¡ä¿®å¤ï¼Œæ•™ç»ƒå‘˜å®¡æ ¸æµç¨‹ç°åœ¨èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œé¿å…äº†ç±»ä¼¼é—®é¢˜çš„å†æ¬¡å‘ç”Ÿã€‚