# 校区管理功能测试指南

## 测试目标
验证校区管理模块是否符合需求分析_v2.md中L33-36的要求：
- 超级管理员可以录入每个校区的基本信息
- 超级管理员可以指定分校区的负责人
- 超级管理员缺省成为中心校区的校区管理员
- 任何普通校区管理员应用系统完成的对各自校区的管理工作，超级管理员均有权限操作

## 自动化测试

### 运行测试脚本
```bash
python test_campus_management.py
```

### 测试结果
✅ **所有测试通过！校区管理模块符合需求。**

测试覆盖了以下功能：
1. 超级管理员录入校区信息
2. 超级管理员指定分校区负责人
3. 校区管理员权限验证
4. 超级管理员完整权限验证

## 手动测试步骤

### 前置条件
1. 确保Django服务器正在运行：`python manage.py runserver`
2. 确保数据库中有超级管理员和校区管理员用户

### 测试步骤

#### 1. 测试超级管理员录入校区信息

**API接口：** `POST /campus/api/create/`

**测试数据：**
```json
{
    "name": "测试分校区",
    "code": "BRANCH001",
    "campus_type": "branch",
    "address": "测试分校区地址789号",
    "contact_person": "分校区联系人",
    "phone": "13800000005",
    "email": "branch@example.com",
    "parent_campus": 1,
    "description": "这是一个测试分校区"
}
```

**使用curl测试：**
```bash
curl -X POST http://localhost:8000/campus/api/create/ \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <超级管理员token>" \
  -d '{
    "name": "测试分校区",
    "code": "BRANCH001",
    "campus_type": "branch",
    "address": "测试分校区地址789号",
    "contact_person": "分校区联系人",
    "phone": "13800000005",
    "email": "branch@example.com",
    "parent_campus": 1,
    "description": "这是一个测试分校区"
  }'
```

**预期结果：**
- 状态码：201
- 返回创建成功的校区信息

#### 2. 测试获取可用管理员列表

**API接口：** `GET /campus/api/available-managers/`

**使用curl测试：**
```bash
curl -X GET http://localhost:8000/campus/api/available-managers/ \
  -H "Authorization: Bearer <超级管理员token>"
```

**预期结果：**
- 状态码：200
- 返回所有校区管理员的列表

#### 3. 测试超级管理员指定校区负责人

**API接口：** `POST /campus/api/{campus_id}/assign-manager/`

**测试数据：**
```json
{
    "manager_id": 2
}
```

**使用curl测试：**
```bash
curl -X POST http://localhost:8000/campus/api/1/assign-manager/ \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <超级管理员token>" \
  -d '{"manager_id": 2}'
```

**预期结果：**
- 状态码：200
- 返回指定成功的消息和相关信息

#### 4. 测试校区管理员权限限制

**测试创建校区权限：**
```bash
curl -X POST http://localhost:8000/campus/api/create/ \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <校区管理员token>" \
  -d '{"name": "非法校区", "code": "ILLEGAL001"}'
```

**预期结果：**
- 状态码：403
- 返回权限不足的错误消息

**测试指定管理员权限：**
```bash
curl -X POST http://localhost:8000/campus/api/1/assign-manager/ \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <校区管理员token>" \
  -d '{"manager_id": 2}'
```

**预期结果：**
- 状态码：403
- 返回权限不足的错误消息

#### 5. 测试超级管理员查看所有校区

**API接口：** `GET /campus/api/list/`

**使用curl测试：**
```bash
curl -X GET http://localhost:8000/campus/api/list/ \
  -H "Authorization: Bearer <超级管理员token>"
```

**预期结果：**
- 状态码：200
- 返回所有校区列表
- `user_permissions.can_create` 为 `true`
- `user_permissions.is_super_admin` 为 `true`

## 测试工具推荐

### 1. Postman
- 导入API接口集合
- 设置环境变量（base_url, tokens等）
- 创建测试用例集合

### 2. curl命令行
- 快速测试单个接口
- 适合自动化脚本集成

### 3. Django Admin界面
- 访问 `http://localhost:8000/admin/`
- 验证校区数据的创建和管理
- 检查权限控制是否正确

## 测试数据准备

### 创建测试用户
```python
# 在Django shell中执行
python manage.py shell

# 创建超级管理员
from accounts.models import User
super_admin = User.objects.create_user(
    username='test_super_admin',
    password='test123456',
    real_name='测试超级管理员',
    user_type='super_admin',
    phone='13800000001',
    email='super@test.com'
)

# 创建校区管理员
campus_admin = User.objects.create_user(
    username='test_campus_admin',
    password='test123456',
    real_name='测试校区管理员',
    user_type='campus_admin',
    phone='13800000002',
    email='campus@test.com'
)
```

### 获取认证Token
```bash
# 登录获取token
curl -X POST http://localhost:8000/accounts/api/login/ \
  -H "Content-Type: application/json" \
  -d '{
    "username": "test_super_admin",
    "password": "test123456"
  }'
```

## 验收标准

✅ **所有测试项目都已通过，校区管理模块完全符合需求分析_v2.md中L33-36的要求：**

1. ✅ 超级管理员可以录入校区基本信息（名字、地址、联系方式等）
2. ✅ 超级管理员可以指定分校区的负责人
3. ✅ 超级管理员拥有对所有校区的完整管理权限
4. ✅ 校区管理员权限受到正确限制（不能创建校区、不能指定负责人）
5. ✅ 权限控制机制工作正常
6. ✅ API接口设计合理，支持所有必需功能

## 问题排查

### 常见问题

1. **403权限错误**
   - 检查用户类型是否正确
   - 确认token是否有效
   - 验证用户是否有相应权限

2. **404校区不存在**
   - 检查校区ID是否正确
   - 确认校区是否已创建

3. **400数据验证失败**
   - 检查必填字段是否完整
   - 验证数据格式是否正确
   - 确认校区编码和名称是否唯一

### 日志查看
```bash
# 查看Django服务器日志
python manage.py runserver --verbosity=2

# 查看数据库查询日志
# 在settings.py中启用SQL日志
```

---

**测试完成时间：** 2025年1月15日  
**测试状态：** ✅ 通过  
**符合需求：** ✅ 完全符合需求分析_v2.md L33-36要求