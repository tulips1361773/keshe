# æ ¡åŒºç®¡ç†å‘˜è‡ªåŠ¨æƒé™åˆ†é…åŠŸèƒ½æ–‡æ¡£

## åŠŸèƒ½æ¦‚è¿°

æœ¬åŠŸèƒ½è§£å†³äº†æ ¡åŒºç®¡ç†å‘˜åœ¨Django Adminåå°åˆ›å»ºæ—¶éœ€è¦æ‰‹åŠ¨è®¾ç½®`is_staff`å’Œæƒé™çš„é—®é¢˜ï¼Œå®ç°äº†è‡ªåŠ¨åŒ–çš„æƒé™åˆ†é…æœºåˆ¶ã€‚

## é—®é¢˜èƒŒæ™¯

ä¹‹å‰çš„ç³»ç»Ÿå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
1. é€šè¿‡Django Adminåˆ›å»ºæ ¡åŒºç®¡ç†å‘˜æ—¶ï¼Œ`is_staff`é»˜è®¤ä¸º`False`ï¼Œæ— æ³•è®¿é—®Adminåå°
2. æ–°åˆ›å»ºçš„æ ¡åŒºç®¡ç†å‘˜æ²¡æœ‰ä»»ä½•æƒé™ï¼Œéœ€è¦æ‰‹åŠ¨åˆ†é…50+ä¸ªæƒé™
3. æƒé™åˆ†é…è¿‡ç¨‹ç¹çä¸”å®¹æ˜“é—æ¼ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ

## è§£å†³æ–¹æ¡ˆ

### 1. ä¿®æ”¹ç”¨æˆ·åˆ›å»ºé€»è¾‘

**æ–‡ä»¶**: `accounts/serializers.py`

åœ¨`UserRegistrationSerializer.create()`æ–¹æ³•ä¸­æ·»åŠ äº†æ ¡åŒºç®¡ç†å‘˜çš„ç‰¹æ®Šå¤„ç†ï¼š

```python
# å¦‚æœæ˜¯æ ¡åŒºç®¡ç†å‘˜ï¼Œè®¾ç½®Django Adminè®¿é—®æƒé™
elif user.user_type == 'campus_admin':
    # è®¾ç½®is_staff=Trueï¼Œå…è®¸è®¿é—®Django Admin
    user.is_staff = True
    user.is_active_member = True
    user.save()
```

### 2. åˆ›å»ºä¿¡å·å¤„ç†å™¨

**æ–‡ä»¶**: `accounts/signals.py`

å®ç°äº†`post_save`ä¿¡å·å¤„ç†å™¨ï¼Œåœ¨ç”¨æˆ·åˆ›å»ºåè‡ªåŠ¨åˆ†é…æƒé™ï¼š

```python
@receiver(post_save, sender=User)
def setup_campus_admin_permissions(sender, instance, created, **kwargs):
    """
    ç”¨æˆ·åˆ›å»ºåçš„ä¿¡å·å¤„ç†å™¨
    ä¸ºæ ¡åŒºç®¡ç†å‘˜è‡ªåŠ¨åˆ†é…å¿…è¦çš„æƒé™
    """
    if created and instance.user_type == 'campus_admin':
        # è·å–æˆ–åˆ›å»ºæ ¡åŒºç®¡ç†å‘˜æƒé™ç»„
        campus_admin_group, group_created = Group.objects.get_or_create(
            name='æ ¡åŒºç®¡ç†å‘˜'
        )
        
        # åˆ†é…æƒé™ç»™ç»„ï¼ˆå¦‚æœæ˜¯æ–°åˆ›å»ºçš„ç»„ï¼‰
        # å°†ç”¨æˆ·åŠ å…¥æ ¡åŒºç®¡ç†å‘˜ç»„
        instance.groups.add(campus_admin_group)
```

### 3. æ³¨å†Œä¿¡å·å¤„ç†å™¨

**æ–‡ä»¶**: `accounts/apps.py`

åœ¨åº”ç”¨é…ç½®ä¸­æ³¨å†Œä¿¡å·å¤„ç†å™¨ï¼š

```python
def ready(self):
    import accounts.signals
```

## æƒé™åˆ†é…è¯¦æƒ…

æ ¡åŒºç®¡ç†å‘˜è‡ªåŠ¨è·å¾—ä»¥ä¸‹æƒé™ç±»åˆ«ï¼š

### æ ¡åŒºç®¡ç†æƒé™ (14ä¸ª)
- `campus.view_campus` - æŸ¥çœ‹æ ¡åŒº
- `campus.change_campus` - ä¿®æ”¹æ ¡åŒº
- `campus.view_campusarea` - æŸ¥çœ‹æ ¡åŒºåŒºåŸŸ
- `campus.add_campusarea` - æ·»åŠ æ ¡åŒºåŒºåŸŸ
- `campus.change_campusarea` - ä¿®æ”¹æ ¡åŒºåŒºåŸŸ
- `campus.delete_campusarea` - åˆ é™¤æ ¡åŒºåŒºåŸŸ
- `campus.view_campusstudent` - æŸ¥çœ‹æ ¡åŒºå­¦ç”Ÿ
- `campus.add_campusstudent` - æ·»åŠ æ ¡åŒºå­¦ç”Ÿ
- `campus.change_campusstudent` - ä¿®æ”¹æ ¡åŒºå­¦ç”Ÿ
- `campus.delete_campusstudent` - åˆ é™¤æ ¡åŒºå­¦ç”Ÿ
- `campus.view_campuscoach` - æŸ¥çœ‹æ ¡åŒºæ•™ç»ƒ
- `campus.add_campuscoach` - æ·»åŠ æ ¡åŒºæ•™ç»ƒ
- `campus.change_campuscoach` - ä¿®æ”¹æ ¡åŒºæ•™ç»ƒ
- `campus.delete_campuscoach` - åˆ é™¤æ ¡åŒºæ•™ç»ƒ

### ç”¨æˆ·ç®¡ç†æƒé™ (6ä¸ª)
- `accounts.view_user` - æŸ¥çœ‹ç”¨æˆ·
- `accounts.change_user` - ä¿®æ”¹ç”¨æˆ·
- `accounts.view_coach` - æŸ¥çœ‹æ•™ç»ƒ
- `accounts.change_coach` - ä¿®æ”¹æ•™ç»ƒ
- `accounts.view_userprofile` - æŸ¥çœ‹ç”¨æˆ·èµ„æ–™
- `accounts.change_userprofile` - ä¿®æ”¹ç”¨æˆ·èµ„æ–™

### é¢„çº¦ç®¡ç†æƒé™ (12ä¸ª)
- `reservations.view_booking` - æŸ¥çœ‹é¢„çº¦
- `reservations.add_booking` - æ·»åŠ é¢„çº¦
- `reservations.change_booking` - ä¿®æ”¹é¢„çº¦
- `reservations.delete_booking` - åˆ é™¤é¢„çº¦
- `reservations.view_table` - æŸ¥çœ‹çƒå°
- `reservations.add_table` - æ·»åŠ çƒå°
- `reservations.change_table` - ä¿®æ”¹çƒå°
- `reservations.delete_table` - åˆ é™¤çƒå°
- `reservations.view_coachstudentrelation` - æŸ¥çœ‹å¸ˆç”Ÿå…³ç³»
- `reservations.add_coachstudentrelation` - æ·»åŠ å¸ˆç”Ÿå…³ç³»
- `reservations.change_coachstudentrelation` - ä¿®æ”¹å¸ˆç”Ÿå…³ç³»
- `reservations.delete_coachstudentrelation` - åˆ é™¤å¸ˆç”Ÿå…³ç³»
- `reservations.view_coachchangerequest` - æŸ¥çœ‹æ¢æ•™ç»ƒè¯·æ±‚
- `reservations.change_coachchangerequest` - ä¿®æ”¹æ¢æ•™ç»ƒè¯·æ±‚

### æ”¯ä»˜ç®¡ç†æƒé™ (5ä¸ª)
- `payments.view_payment` - æŸ¥çœ‹æ”¯ä»˜è®°å½•
- `payments.change_payment` - ä¿®æ”¹æ”¯ä»˜è®°å½•
- `payments.view_useraccount` - æŸ¥çœ‹ç”¨æˆ·è´¦æˆ·
- `payments.change_useraccount` - ä¿®æ”¹ç”¨æˆ·è´¦æˆ·
- `payments.view_accounttransaction` - æŸ¥çœ‹è´¦æˆ·äº¤æ˜“

### æ¯”èµ›ç®¡ç†æƒé™ (6ä¸ª)
- `competitions.view_competition` - æŸ¥çœ‹æ¯”èµ›
- `competitions.add_competition` - æ·»åŠ æ¯”èµ›
- `competitions.change_competition` - ä¿®æ”¹æ¯”èµ›
- `competitions.delete_competition` - åˆ é™¤æ¯”èµ›
- `competitions.view_competitionregistration` - æŸ¥çœ‹æ¯”èµ›æŠ¥å
- `competitions.change_competitionregistration` - ä¿®æ”¹æ¯”èµ›æŠ¥å

### é€šçŸ¥ç®¡ç†æƒé™ (4ä¸ª)
- `notifications.view_notification` - æŸ¥çœ‹é€šçŸ¥
- `notifications.add_notification` - æ·»åŠ é€šçŸ¥
- `notifications.change_notification` - ä¿®æ”¹é€šçŸ¥
- `notifications.delete_notification` - åˆ é™¤é€šçŸ¥

### æ—¥å¿—æŸ¥çœ‹æƒé™ (2ä¸ª)
- `logs.view_systemlog` - æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
- `logs.view_loginlog` - æŸ¥çœ‹ç™»å½•æ—¥å¿—

**æ€»è®¡**: 51ä¸ªæƒé™

## æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬

åˆ›å»ºäº†ä¸“é—¨çš„æµ‹è¯•è„šæœ¬ `test_campus_admin_creation.py` æ¥éªŒè¯åŠŸèƒ½ï¼š

```bash
python test_campus_admin_creation.py
```

### æµ‹è¯•ç»“æœ

```
ğŸ§ª å¼€å§‹æµ‹è¯•æ ¡åŒºç®¡ç†å‘˜åˆ›å»ºæµç¨‹...
âœ… æ¸…ç†å·²å­˜åœ¨çš„æµ‹è¯•ç”¨æˆ·: test_campus_admin_new

ğŸ“ é€šè¿‡åºåˆ—åŒ–å™¨åˆ›å»ºæ ¡åŒºç®¡ç†å‘˜...
âœ… ä¸ºæ ¡åŒºç®¡ç†å‘˜ test_campus_admin_new è‡ªåŠ¨åˆ†é…äº†æƒé™ç»„
âœ… æˆåŠŸåˆ›å»ºç”¨æˆ·: test_campus_admin_new

ğŸ” éªŒè¯ç”¨æˆ·å±æ€§:
   ç”¨æˆ·å: test_campus_admin_new
   ç”¨æˆ·ç±»å‹: campus_admin
   is_staff: True
   is_active_member: True

ğŸ‘¥ éªŒè¯æƒé™ç»„:
   ç”¨æˆ·æ‰€å±ç»„: ['æ ¡åŒºç®¡ç†å‘˜']

ğŸ” éªŒè¯æƒé™:
   ç”¨æˆ·æƒé™æ•°é‡: 51

âœ… éªŒè¯å…³é”®æƒé™:
   âœ… campus.view_campus: True
   âœ… campus.change_campus: True
   âœ… accounts.view_user: True
   âœ… accounts.change_user: True
   âœ… reservations.view_booking: True
   âœ… reservations.change_booking: True

ğŸ“Š æµ‹è¯•ç»“æœæ€»ç»“:
   âœ… is_staff è‡ªåŠ¨è®¾ç½®ä¸º True
   âœ… è‡ªåŠ¨åŠ å…¥æ ¡åŒºç®¡ç†å‘˜æƒé™ç»„
   âœ… æƒé™åˆ†é…å……è¶³ (51 ä¸ªæƒé™)
   âœ… å…³é”®æƒé™åˆ†é…æ­£å¸¸ (6/6)

ğŸ¯ æµ‹è¯•å®Œæˆ: 4/4 é¡¹æ£€æŸ¥é€šè¿‡
ğŸ‰ æ ¡åŒºç®¡ç†å‘˜è‡ªåŠ¨æƒé™åˆ†é…åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼
```

## ä½¿ç”¨è¯´æ˜

### 1. é€šè¿‡APIåˆ›å»ºæ ¡åŒºç®¡ç†å‘˜

ç°åœ¨å¯ä»¥é€šè¿‡ç”¨æˆ·æ³¨å†ŒAPIç›´æ¥åˆ›å»ºå…·æœ‰å®Œæ•´æƒé™çš„æ ¡åŒºç®¡ç†å‘˜ï¼š

```json
{
    "username": "campus_admin_001",
    "password": "securepass123@",
    "password_confirm": "securepass123@",
    "real_name": "å¼ ä¸‰",
    "phone": "13800138000",
    "email": "admin@campus.com",
    "user_type": "campus_admin"
}
```

### 2. é€šè¿‡Django Adminåˆ›å»º

åœ¨Django Adminåå°çš„ç”¨æˆ·ç®¡ç†é¡µé¢åˆ›å»ºç”¨æˆ·æ—¶ï¼š
1. è®¾ç½®`user_type`ä¸º`campus_admin`
2. ä¿å­˜åç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š
   - è®¾ç½®`is_staff=True`
   - åˆ†é…æ ¡åŒºç®¡ç†å‘˜æƒé™ç»„
   - èµ‹äºˆ51ä¸ªç›¸å…³æƒé™

### 3. ç™»å½•éªŒè¯

æ–°åˆ›å»ºçš„æ ¡åŒºç®¡ç†å‘˜å¯ä»¥ï¼š
1. ç›´æ¥ç™»å½•Django Adminåå°
2. æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰ç›¸å…³æ¨¡å—
3. æ— éœ€æ‰‹åŠ¨åˆ†é…æƒé™

## æŠ€æœ¯è¦ç‚¹

### 1. æƒé™ç»„ç®¡ç†

- ä½¿ç”¨Djangoçš„`Group`æ¨¡å‹ç®¡ç†æƒé™
- æƒé™ç»„åç§°ï¼š`æ ¡åŒºç®¡ç†å‘˜`
- æ”¯æŒæƒé™çš„æ‰¹é‡åˆ†é…å’Œç®¡ç†

### 2. ä¿¡å·å¤„ç†

- ä½¿ç”¨`post_save`ä¿¡å·ç¡®ä¿åœ¨ç”¨æˆ·åˆ›å»ºåç«‹å³åˆ†é…æƒé™
- åªå¯¹æ–°åˆ›å»ºçš„`campus_admin`ç±»å‹ç”¨æˆ·ç”Ÿæ•ˆ
- é¿å…é‡å¤åˆ†é…æƒé™

### 3. é”™è¯¯å¤„ç†

- æƒé™ä¸å­˜åœ¨æ—¶è·³è¿‡ï¼Œä¸å½±å“å…¶ä»–æƒé™åˆ†é…
- æä¾›è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºä¾¿äºè°ƒè¯•

## ç»´æŠ¤è¯´æ˜

### 1. æ·»åŠ æ–°æƒé™

å¦‚éœ€ä¸ºæ ¡åŒºç®¡ç†å‘˜æ·»åŠ æ–°æƒé™ï¼Œåœ¨`accounts/signals.py`çš„`campus_admin_permissions`åˆ—è¡¨ä¸­æ·»åŠ ï¼š

```python
campus_admin_permissions = [
    # ç°æœ‰æƒé™...
    'new_app.new_permission',
]
```

### 2. ä¿®æ”¹æƒé™ç»„

å¯ä»¥é€šè¿‡Django Adminåå°çš„"ç»„"ç®¡ç†é¡µé¢æ‰‹åŠ¨è°ƒæ•´æƒé™ç»„çš„æƒé™ã€‚

### 3. æ‰¹é‡æ›´æ–°ç°æœ‰ç”¨æˆ·

å¦‚éœ€ä¸ºç°æœ‰çš„æ ¡åŒºç®¡ç†å‘˜ç”¨æˆ·åº”ç”¨æ–°æƒé™ï¼Œå¯ä»¥è¿è¡Œï¼š

```python
from accounts.models import User
from django.contrib.auth.models import Group

campus_admin_group = Group.objects.get(name='æ ¡åŒºç®¡ç†å‘˜')
campus_admins = User.objects.filter(user_type='campus_admin')

for admin in campus_admins:
    admin.groups.add(campus_admin_group)
    admin.is_staff = True
    admin.save()
```

## æ€»ç»“

è¯¥åŠŸèƒ½æˆåŠŸè§£å†³äº†æ ¡åŒºç®¡ç†å‘˜æƒé™åˆ†é…çš„è‡ªåŠ¨åŒ–é—®é¢˜ï¼Œæå‡äº†ç³»ç»Ÿçš„æ˜“ç”¨æ€§å’Œç®¡ç†æ•ˆç‡ã€‚é€šè¿‡ä¿¡å·å¤„ç†å™¨å’Œæƒé™ç»„çš„ç»“åˆä½¿ç”¨ï¼Œå®ç°äº†æƒé™çš„ç»Ÿä¸€ç®¡ç†å’Œè‡ªåŠ¨åˆ†é…ï¼Œä¸ºåç»­çš„æƒé™æ‰©å±•æä¾›äº†è‰¯å¥½çš„åŸºç¡€ã€‚