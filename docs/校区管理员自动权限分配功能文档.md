# 校区管理员自动权限分配功能文档

## 功能概述

本功能解决了校区管理员在Django Admin后台创建时需要手动设置`is_staff`和权限的问题，实现了自动化的权限分配机制。

## 问题背景

之前的系统存在以下问题：
1. 通过Django Admin创建校区管理员时，`is_staff`默认为`False`，无法访问Admin后台
2. 新创建的校区管理员没有任何权限，需要手动分配50+个权限
3. 权限分配过程繁琐且容易遗漏，影响用户体验

## 解决方案

### 1. 修改用户创建逻辑

**文件**: `accounts/serializers.py`

在`UserRegistrationSerializer.create()`方法中添加了校区管理员的特殊处理：

```python
# 如果是校区管理员，设置Django Admin访问权限
elif user.user_type == 'campus_admin':
    # 设置is_staff=True，允许访问Django Admin
    user.is_staff = True
    user.is_active_member = True
    user.save()
```

### 2. 创建信号处理器

**文件**: `accounts/signals.py`

实现了`post_save`信号处理器，在用户创建后自动分配权限：

```python
@receiver(post_save, sender=User)
def setup_campus_admin_permissions(sender, instance, created, **kwargs):
    """
    用户创建后的信号处理器
    为校区管理员自动分配必要的权限
    """
    if created and instance.user_type == 'campus_admin':
        # 获取或创建校区管理员权限组
        campus_admin_group, group_created = Group.objects.get_or_create(
            name='校区管理员'
        )
        
        # 分配权限给组（如果是新创建的组）
        # 将用户加入校区管理员组
        instance.groups.add(campus_admin_group)
```

### 3. 注册信号处理器

**文件**: `accounts/apps.py`

在应用配置中注册信号处理器：

```python
def ready(self):
    import accounts.signals
```

## 权限分配详情

校区管理员自动获得以下权限类别：

### 校区管理权限 (14个)
- `campus.view_campus` - 查看校区
- `campus.change_campus` - 修改校区
- `campus.view_campusarea` - 查看校区区域
- `campus.add_campusarea` - 添加校区区域
- `campus.change_campusarea` - 修改校区区域
- `campus.delete_campusarea` - 删除校区区域
- `campus.view_campusstudent` - 查看校区学生
- `campus.add_campusstudent` - 添加校区学生
- `campus.change_campusstudent` - 修改校区学生
- `campus.delete_campusstudent` - 删除校区学生
- `campus.view_campuscoach` - 查看校区教练
- `campus.add_campuscoach` - 添加校区教练
- `campus.change_campuscoach` - 修改校区教练
- `campus.delete_campuscoach` - 删除校区教练

### 用户管理权限 (6个)
- `accounts.view_user` - 查看用户
- `accounts.change_user` - 修改用户
- `accounts.view_coach` - 查看教练
- `accounts.change_coach` - 修改教练
- `accounts.view_userprofile` - 查看用户资料
- `accounts.change_userprofile` - 修改用户资料

### 预约管理权限 (12个)
- `reservations.view_booking` - 查看预约
- `reservations.add_booking` - 添加预约
- `reservations.change_booking` - 修改预约
- `reservations.delete_booking` - 删除预约
- `reservations.view_table` - 查看球台
- `reservations.add_table` - 添加球台
- `reservations.change_table` - 修改球台
- `reservations.delete_table` - 删除球台
- `reservations.view_coachstudentrelation` - 查看师生关系
- `reservations.add_coachstudentrelation` - 添加师生关系
- `reservations.change_coachstudentrelation` - 修改师生关系
- `reservations.delete_coachstudentrelation` - 删除师生关系
- `reservations.view_coachchangerequest` - 查看换教练请求
- `reservations.change_coachchangerequest` - 修改换教练请求

### 支付管理权限 (5个)
- `payments.view_payment` - 查看支付记录
- `payments.change_payment` - 修改支付记录
- `payments.view_useraccount` - 查看用户账户
- `payments.change_useraccount` - 修改用户账户
- `payments.view_accounttransaction` - 查看账户交易

### 比赛管理权限 (6个)
- `competitions.view_competition` - 查看比赛
- `competitions.add_competition` - 添加比赛
- `competitions.change_competition` - 修改比赛
- `competitions.delete_competition` - 删除比赛
- `competitions.view_competitionregistration` - 查看比赛报名
- `competitions.change_competitionregistration` - 修改比赛报名

### 通知管理权限 (4个)
- `notifications.view_notification` - 查看通知
- `notifications.add_notification` - 添加通知
- `notifications.change_notification` - 修改通知
- `notifications.delete_notification` - 删除通知

### 日志查看权限 (2个)
- `logs.view_systemlog` - 查看系统日志
- `logs.view_loginlog` - 查看登录日志

**总计**: 51个权限

## 测试验证

### 测试脚本

创建了专门的测试脚本 `test_campus_admin_creation.py` 来验证功能：

```bash
python test_campus_admin_creation.py
```

### 测试结果

```
🧪 开始测试校区管理员创建流程...
✅ 清理已存在的测试用户: test_campus_admin_new

📝 通过序列化器创建校区管理员...
✅ 为校区管理员 test_campus_admin_new 自动分配了权限组
✅ 成功创建用户: test_campus_admin_new

🔍 验证用户属性:
   用户名: test_campus_admin_new
   用户类型: campus_admin
   is_staff: True
   is_active_member: True

👥 验证权限组:
   用户所属组: ['校区管理员']

🔐 验证权限:
   用户权限数量: 51

✅ 验证关键权限:
   ✅ campus.view_campus: True
   ✅ campus.change_campus: True
   ✅ accounts.view_user: True
   ✅ accounts.change_user: True
   ✅ reservations.view_booking: True
   ✅ reservations.change_booking: True

📊 测试结果总结:
   ✅ is_staff 自动设置为 True
   ✅ 自动加入校区管理员权限组
   ✅ 权限分配充足 (51 个权限)
   ✅ 关键权限分配正常 (6/6)

🎯 测试完成: 4/4 项检查通过
🎉 校区管理员自动权限分配功能正常工作！
```

## 使用说明

### 1. 通过API创建校区管理员

现在可以通过用户注册API直接创建具有完整权限的校区管理员：

```json
{
    "username": "campus_admin_001",
    "password": "securepass123@",
    "password_confirm": "securepass123@",
    "real_name": "张三",
    "phone": "13800138000",
    "email": "admin@campus.com",
    "user_type": "campus_admin"
}
```

### 2. 通过Django Admin创建

在Django Admin后台的用户管理页面创建用户时：
1. 设置`user_type`为`campus_admin`
2. 保存后系统会自动：
   - 设置`is_staff=True`
   - 分配校区管理员权限组
   - 赋予51个相关权限

### 3. 登录验证

新创建的校区管理员可以：
1. 直接登录Django Admin后台
2. 查看和管理所有相关模块
3. 无需手动分配权限

## 技术要点

### 1. 权限组管理

- 使用Django的`Group`模型管理权限
- 权限组名称：`校区管理员`
- 支持权限的批量分配和管理

### 2. 信号处理

- 使用`post_save`信号确保在用户创建后立即分配权限
- 只对新创建的`campus_admin`类型用户生效
- 避免重复分配权限

### 3. 错误处理

- 权限不存在时跳过，不影响其他权限分配
- 提供详细的日志输出便于调试

## 维护说明

### 1. 添加新权限

如需为校区管理员添加新权限，在`accounts/signals.py`的`campus_admin_permissions`列表中添加：

```python
campus_admin_permissions = [
    # 现有权限...
    'new_app.new_permission',
]
```

### 2. 修改权限组

可以通过Django Admin后台的"组"管理页面手动调整权限组的权限。

### 3. 批量更新现有用户

如需为现有的校区管理员用户应用新权限，可以运行：

```python
from accounts.models import User
from django.contrib.auth.models import Group

campus_admin_group = Group.objects.get(name='校区管理员')
campus_admins = User.objects.filter(user_type='campus_admin')

for admin in campus_admins:
    admin.groups.add(campus_admin_group)
    admin.is_staff = True
    admin.save()
```

## 总结

该功能成功解决了校区管理员权限分配的自动化问题，提升了系统的易用性和管理效率。通过信号处理器和权限组的结合使用，实现了权限的统一管理和自动分配，为后续的权限扩展提供了良好的基础。