# 用户管理功能测试文档

## 概述

本文档记录了乒乓球培训管理系统中用户管理相关功能的测试情况，包括用户注册、登录、资料维护等核心功能的测试结果和验证情况。

## 测试环境

- **系统版本**: Django 4.2
- **数据库**: SQLite3
- **测试框架**: 自定义测试脚本
- **测试时间**: 2025年9月12日

## 功能测试概览

### 1. 学员注册功能测试

**测试脚本**: `test_student_registration.py`

**测试结果**: ✅ 全部通过 (4/4)

#### 测试项目

1. **学员注册成功** ✅
   - 验证正常学员注册流程
   - 确认用户数据正确保存
   - 验证默认激活状态

2. **必填字段验证** ✅ (5/5)
   - 用户名为空验证
   - 真实姓名为空验证
   - 手机号为空验证
   - 邮箱为空验证
   - 用户类型为空验证

3. **密码复杂度验证** ✅ (6/6)
   - 密码长度不足验证
   - 密码过长验证
   - 缺少字母验证
   - 缺少数字验证
   - 缺少特殊字符验证
   - 密码确认不匹配验证

4. **重复数据验证** ✅
   - 用户名重复验证
   - 手机号重复验证
   - 邮箱重复验证

### 2. 教练员注册和审核功能测试

**测试脚本**: `test_coach_registration.py`

**测试结果**: ✅ 全部通过 (5/5)

#### 测试项目

1. **教练员注册** ✅
   - 验证教练员注册流程
   - 确认成就描述字段处理
   - 验证默认待审核状态

2. **审核前登录拒绝** ✅
   - 验证未审核教练员无法登录
   - 确认返回适当的错误信息

3. **审核流程** ✅
   - 验证管理员审核功能
   - 确认审核后状态更新

4. **审核后登录** ✅
   - 验证审核通过后可正常登录
   - 确认登录token生成

5. **必填字段验证** ✅
   - 验证成就描述为必填项
   - 确认空值被正确拒绝

### 3. 用户信息维护功能测试

**测试脚本**: `test_user_profile_management.py`

**测试结果**: ✅ 全部通过 (5/5)

#### 测试项目

1. **获取用户资料** ✅
   - 验证用户资料API正常工作
   - 确认返回完整用户信息

2. **更新用户资料** ✅
   - 验证资料更新功能
   - 确认各字段正确更新
   - 验证扩展资料字段处理

3. **修改密码** ✅
   - 验证密码修改流程
   - 确认新密码生效
   - 验证旧密码失效

4. **密码修改验证** ✅ (3/3)
   - 旧密码错误验证
   - 新密码确认不匹配验证
   - 新密码复杂度验证

5. **资料字段验证** ✅ (2/2)
   - 邮箱格式验证
   - 手机号格式验证

## 核心功能实现

### 用户模型设计

系统采用扩展的用户模型设计：

- **基础用户模型** (`User`): 继承Django AbstractUser，包含基本用户信息
- **用户资料模型** (`UserProfile`): 一对一关联，存储扩展信息
- **教练员模型** (`Coach`): 存储教练员特有信息和审核状态

### 关键技术实现

#### 1. 用户注册验证

```python
# 密码复杂度验证
def validate_password(self, value):
    import re
    if len(value) < 8 or len(value) > 16:
        raise serializers.ValidationError('密码长度必须为8-16位')
    if not re.search(r'[a-zA-Z]', value):
        raise serializers.ValidationError('密码必须包含字母')
    if not re.search(r'\d', value):
        raise serializers.ValidationError('密码必须包含数字')
    if not re.search(r'[!@#$%^&*(),.?":{}|<>]', value):
        raise serializers.ValidationError('密码必须包含特殊字符')
```

#### 2. 教练员审核机制

```python
# 教练员登录时检查审核状态
if user.user_type == 'coach' and not user.is_active_member:
    return Response({
        'success': False,
        'message': '您的账户正在审核中，请等待管理员审核通过后再登录'
    }, status=status.HTTP_403_FORBIDDEN)
```

#### 3. 资料更新验证

```python
# 邮箱格式验证
def validate_email(self, value):
    if value:
        import re
        email_pattern = r'^[^\s@]+@[^\s@]+\.[^\s@]+$'
        if not re.match(email_pattern, value):
            raise serializers.ValidationError('邮箱格式不正确')
```

## API接口文档

### 用户注册

- **URL**: `/accounts/api/register/`
- **方法**: POST
- **参数**: username, password, password_confirm, real_name, phone, email, user_type, gender
- **返回**: 注册结果和用户信息

### 用户登录

- **URL**: `/accounts/api/login/`
- **方法**: POST
- **参数**: username, password
- **返回**: 登录token和用户信息

### 获取用户资料

- **URL**: `/accounts/api/profile/`
- **方法**: GET
- **认证**: 需要Token认证
- **返回**: 用户基本信息和扩展资料

### 更新用户资料

- **URL**: `/accounts/api/profile/update/`
- **方法**: PUT
- **认证**: 需要Token认证
- **参数**: real_name, email, gender, address, emergency_contact, emergency_phone, bio, skills, experience_years
- **返回**: 更新结果和最新用户信息

### 修改密码

- **URL**: `/accounts/api/change-password/`
- **方法**: POST
- **认证**: 需要Token认证
- **参数**: old_password, new_password, confirm_password
- **返回**: 修改结果

## 数据验证规则

### 用户名验证
- 不能为空
- 不能重复
- 长度限制：3-20个字符

### 密码验证
- 长度：8-16位
- 必须包含：字母、数字、特殊字符
- 确认密码必须匹配

### 手机号验证
- 格式：1[3-9]\d{9}
- 不能重复注册

### 邮箱验证
- 格式：标准邮箱格式
- 不能重复注册（可选字段）

### 教练员特殊验证
- 成就描述为必填项
- 注册后默认待审核状态
- 审核通过前不能登录

## 安全特性

1. **密码安全**
   - 密码哈希存储
   - 复杂度要求
   - 旧密码验证

2. **数据验证**
   - 服务端验证所有输入
   - 防止重复注册
   - 格式验证

3. **权限控制**
   - Token认证
   - 教练员审核机制
   - 用户类型区分

## 测试覆盖率

| 功能模块 | 测试用例数 | 通过数 | 覆盖率 |
|---------|-----------|--------|--------|
| 学员注册 | 4 | 4 | 100% |
| 教练员注册审核 | 5 | 5 | 100% |
| 用户信息维护 | 5 | 5 | 100% |
| **总计** | **14** | **14** | **100%** |

## 问题修复记录

### 1. API路径问题
**问题**: 测试脚本中API路径不正确
**解决**: 将 `/api/accounts/register/` 修正为 `/accounts/api/register/`

### 2. 教练员注册字段问题
**问题**: User模型收到意外的achievements字段
**解决**: 在序列化器中正确处理achievements字段，保存到Coach模型

### 3. 教练员审核状态检查
**问题**: 未审核教练员可以登录
**解决**: 在登录视图中添加审核状态检查

### 4. 资料更新验证缺失
**问题**: 邮箱和手机号格式验证不生效
**解决**: 创建专门的UserProfileUpdateSerializer并添加字段验证

## 结论

用户管理功能测试全面完成，所有核心功能均正常工作：

✅ **学员注册流程** - 完整的注册验证和数据保存
✅ **教练员审核机制** - 注册、审核、登录的完整流程
✅ **用户信息维护** - 资料更新、密码修改、字段验证
✅ **数据安全性** - 完善的验证规则和安全措施
✅ **API接口** - 标准化的RESTful接口设计

系统的用户管理功能已达到生产环境要求，可以支持正常的用户注册、登录和资料管理需求。

---

**文档版本**: 1.0  
**最后更新**: 2025年9月12日  
**测试负责人**: AI助手  
**审核状态**: 已完成