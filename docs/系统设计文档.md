# 乒乓球培训管理系统设计文档

## 1. 系统架构设计

### 1.1 总体架构

```
┌─────────────────────────────────────────────────────────┐
│                    前端展示层                              │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │
│  │  管理员界面  │ │  教练员界面  │ │  学员界面    │      │
│  └─────────────┘ └─────────────┘ └─────────────┘      │
└─────────────────────────────────────────────────────────┘
                            │
                    HTTP/HTTPS 请求
                            │
┌─────────────────────────────────────────────────────────┐
│                   Web服务层                              │
│  ┌─────────────────────────────────────────────────────┐ │
│  │              Django Web Framework                   │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐  │ │
│  │  │ 用户管理 │ │ 课程管理 │ │ 支付管理 │ │ 比赛管理 │  │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘  │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
                            │
                      ORM映射
                            │
┌─────────────────────────────────────────────────────────┐
│                   数据持久层                              │
│  ┌─────────────────────────────────────────────────────┐ │
│  │                  MySQL数据库                        │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐  │ │
│  │  │ 用户表   │ │ 课程表   │ │ 支付表   │ │ 比赛表   │  │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘  │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 1.2 技术架构

- **前端技术**：HTML5 + CSS3 + JavaScript + Bootstrap
- **后端框架**：Django 4.x
- **数据库**：MySQL 8.0
- **Web服务器**：Nginx + Gunicorn
- **缓存**：Redis（可选）
- **支付接口**：微信支付API + 支付宝API

### 1.3 模块划分

#### 1.3.1 核心模块
- **用户认证模块**（accounts）
- **校区管理模块**（campus）
- **课程管理模块**（courses）
- **支付管理模块**（payments）
- **比赛管理模块**（competitions）
- **消息通知模块**（notifications）
- **系统日志模块**（logs）

#### 1.3.2 公共模块
- **权限控制模块**（permissions）
- **工具类模块**（utils）
- **配置管理模块**（settings）

## 2. 数据库设计

### 2.1 数据库概念模型（ER图）

```
用户(User) ──┐
            │
            ├── 学员(Student)
            ├── 教练员(Coach) 
            ├── 校区管理员(CampusAdmin)
            └── 超级管理员(SuperAdmin)
            │
            │ 1:N
            ▼
          校区(Campus)
            │
            │ 1:N
            ▼
        双选关系(CoachStudentRelation)
            │
            │ 1:N
            ▼
        课程预约(Booking)
            │
            │ 1:1
            ▼
        支付记录(Payment)
```

### 2.2 数据表设计

#### 2.2.1 用户相关表

**用户基础表 (users)**
```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL COMMENT '用户名',
    password VARCHAR(128) NOT NULL COMMENT '密码哈希',
    real_name VARCHAR(50) NOT NULL COMMENT '真实姓名',
    gender ENUM('M', 'F', 'U') DEFAULT 'U' COMMENT '性别：M男，F女，U未知',
    age INT COMMENT '年龄',
    phone VARCHAR(20) NOT NULL COMMENT '电话',
    email VARCHAR(100) COMMENT '邮箱',
    avatar VARCHAR(200) COMMENT '头像路径',
    user_type ENUM('student', 'coach', 'campus_admin', 'super_admin') NOT NULL COMMENT '用户类型',
    campus_id BIGINT COMMENT '所属校区ID',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否激活',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_username (username),
    INDEX idx_phone (phone),
    INDEX idx_campus_id (campus_id)
);
```

**教练员扩展表 (coaches)**
```sql
CREATE TABLE coaches (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT UNIQUE NOT NULL COMMENT '用户ID',
    coach_level ENUM('senior', 'intermediate', 'junior') NOT NULL COMMENT '教练等级',
    hourly_rate DECIMAL(10,2) NOT NULL COMMENT '每小时费用',
    achievements TEXT COMMENT '比赛成绩描述',
    max_students INT DEFAULT 20 COMMENT '最大学员数',
    current_students INT DEFAULT 0 COMMENT '当前学员数',
    status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending' COMMENT '审核状态',
    approved_by BIGINT COMMENT '审核人ID',
    approved_at TIMESTAMP NULL COMMENT '审核时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (approved_by) REFERENCES users(id)
);
```

**学员扩展表 (students)**
```sql
CREATE TABLE students (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT UNIQUE NOT NULL COMMENT '用户ID',
    account_balance DECIMAL(10,2) DEFAULT 0.00 COMMENT '账户余额',
    max_coaches INT DEFAULT 2 COMMENT '最大教练数',
    current_coaches INT DEFAULT 0 COMMENT '当前教练数',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### 2.2.2 校区管理表

**校区表 (campuses)**
```sql
CREATE TABLE campuses (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL COMMENT '校区名称',
    address VARCHAR(200) COMMENT '地址',
    contact_person VARCHAR(50) COMMENT '联系人',
    contact_phone VARCHAR(20) COMMENT '联系电话',
    contact_email VARCHAR(100) COMMENT '联系邮箱',
    is_main_campus BOOLEAN DEFAULT FALSE COMMENT '是否为中心校区',
    admin_id BIGINT COMMENT '校区管理员ID',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否激活',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (admin_id) REFERENCES users(id)
);
```

**球台表 (tables)**
```sql
CREATE TABLE tables (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    campus_id BIGINT NOT NULL COMMENT '校区ID',
    table_number VARCHAR(20) NOT NULL COMMENT '球台编号',
    is_available BOOLEAN DEFAULT TRUE COMMENT '是否可用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (campus_id) REFERENCES campuses(id) ON DELETE CASCADE,
    UNIQUE KEY uk_campus_table (campus_id, table_number)
);
```

#### 2.2.3 师生关系表

**双选关系表 (coach_student_relations)**
```sql
CREATE TABLE coach_student_relations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    coach_id BIGINT NOT NULL COMMENT '教练ID',
    student_id BIGINT NOT NULL COMMENT '学员ID',
    status ENUM('pending', 'approved', 'rejected', 'terminated') DEFAULT 'pending' COMMENT '关系状态',
    applied_by ENUM('student', 'coach') NOT NULL COMMENT '申请方',
    applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '申请时间',
    processed_at TIMESTAMP NULL COMMENT '处理时间',
    terminated_at TIMESTAMP NULL COMMENT '终止时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (coach_id) REFERENCES coaches(id) ON DELETE CASCADE,
    FOREIGN KEY (student_id) REFERENCES students(id) ON DELETE CASCADE,
    UNIQUE KEY uk_coach_student_active (coach_id, student_id, status)
);
```

#### 2.2.4 课程预约表

**课程预约表 (bookings)**
```sql
CREATE TABLE bookings (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    relation_id BIGINT NOT NULL COMMENT '师生关系ID',
    table_id BIGINT NOT NULL COMMENT '球台ID',
    start_time DATETIME NOT NULL COMMENT '开始时间',
    end_time DATETIME NOT NULL COMMENT '结束时间',
    duration_hours DECIMAL(3,1) NOT NULL COMMENT '时长（小时）',
    total_fee DECIMAL(10,2) NOT NULL COMMENT '总费用',
    status ENUM('pending', 'confirmed', 'completed', 'cancelled') DEFAULT 'pending' COMMENT '预约状态',
    confirmed_at TIMESTAMP NULL COMMENT '确认时间',
    cancelled_at TIMESTAMP NULL COMMENT '取消时间',
    cancel_reason TEXT COMMENT '取消原因',
    cancelled_by BIGINT COMMENT '取消人ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (relation_id) REFERENCES coach_student_relations(id) ON DELETE CASCADE,
    FOREIGN KEY (table_id) REFERENCES tables(id),
    FOREIGN KEY (cancelled_by) REFERENCES users(id),
    INDEX idx_start_time (start_time),
    INDEX idx_status (status)
);
```

#### 2.2.5 支付相关表

**支付记录表 (payments)**
```sql
CREATE TABLE payments (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    booking_id BIGINT COMMENT '预约ID（课程支付）',
    competition_id BIGINT COMMENT '比赛ID（报名费）',
    payment_type ENUM('recharge', 'course_fee', 'competition_fee', 'refund') NOT NULL COMMENT '支付类型',
    amount DECIMAL(10,2) NOT NULL COMMENT '金额',
    payment_method ENUM('wechat', 'alipay', 'offline') NOT NULL COMMENT '支付方式',
    transaction_id VARCHAR(100) COMMENT '交易流水号',
    status ENUM('pending', 'success', 'failed', 'refunded') DEFAULT 'pending' COMMENT '支付状态',
    processed_by BIGINT COMMENT '处理人ID（线下支付）',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (booking_id) REFERENCES bookings(id),
    FOREIGN KEY (processed_by) REFERENCES users(id),
    INDEX idx_user_id (user_id),
    INDEX idx_status (status)
);
```

#### 2.2.6 比赛管理表

**比赛表 (competitions)**
```sql
CREATE TABLE competitions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    campus_id BIGINT NOT NULL COMMENT '校区ID',
    name VARCHAR(100) NOT NULL COMMENT '比赛名称',
    competition_date DATE NOT NULL COMMENT '比赛日期',
    registration_fee DECIMAL(10,2) DEFAULT 30.00 COMMENT '报名费',
    registration_deadline DATETIME NOT NULL COMMENT '报名截止时间',
    status ENUM('upcoming', 'registration_open', 'registration_closed', 'in_progress', 'completed') DEFAULT 'upcoming',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (campus_id) REFERENCES campuses(id) ON DELETE CASCADE
);
```

**比赛组别表 (competition_groups)**
```sql
CREATE TABLE competition_groups (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    competition_id BIGINT NOT NULL COMMENT '比赛ID',
    group_name ENUM('A', 'B', 'C') NOT NULL COMMENT '组别名称',
    max_participants INT DEFAULT 6 COMMENT '最大参赛人数',
    current_participants INT DEFAULT 0 COMMENT '当前参赛人数',
    FOREIGN KEY (competition_id) REFERENCES competitions(id) ON DELETE CASCADE,
    UNIQUE KEY uk_competition_group (competition_id, group_name)
);
```

**比赛报名表 (competition_registrations)**
```sql
CREATE TABLE competition_registrations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    student_id BIGINT NOT NULL COMMENT '学员ID',
    group_id BIGINT NOT NULL COMMENT '组别ID',
    registration_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    payment_status ENUM('pending', 'paid') DEFAULT 'pending',
    FOREIGN KEY (student_id) REFERENCES students(id) ON DELETE CASCADE,
    FOREIGN KEY (group_id) REFERENCES competition_groups(id) ON DELETE CASCADE,
    UNIQUE KEY uk_student_group (student_id, group_id)
);
```

#### 2.2.7 评价系统表

**课程评价表 (course_evaluations)**
```sql
CREATE TABLE course_evaluations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    booking_id BIGINT NOT NULL COMMENT '预约ID',
    evaluator_id BIGINT NOT NULL COMMENT '评价人ID',
    evaluator_type ENUM('student', 'coach') NOT NULL COMMENT '评价人类型',
    content TEXT NOT NULL COMMENT '评价内容',
    rating INT COMMENT '评分（1-5）',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (booking_id) REFERENCES bookings(id) ON DELETE CASCADE,
    FOREIGN KEY (evaluator_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### 2.2.8 消息通知表

**系统消息表 (notifications)**
```sql
CREATE TABLE notifications (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    recipient_id BIGINT NOT NULL COMMENT '接收人ID',
    sender_id BIGINT COMMENT '发送人ID',
    title VARCHAR(200) NOT NULL COMMENT '消息标题',
    content TEXT NOT NULL COMMENT '消息内容',
    message_type ENUM('system', 'booking', 'payment', 'competition', 'evaluation') NOT NULL COMMENT '消息类型',
    is_read BOOLEAN DEFAULT FALSE COMMENT '是否已读',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (recipient_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (sender_id) REFERENCES users(id) ON DELETE SET NULL,
    INDEX idx_recipient_unread (recipient_id, is_read)
);
```

#### 2.2.9 系统日志表

**操作日志表 (system_logs)**
```sql
CREATE TABLE system_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT COMMENT '操作用户ID',
    campus_id BIGINT COMMENT '校区ID',
    action_type VARCHAR(50) NOT NULL COMMENT '操作类型',
    action_description TEXT NOT NULL COMMENT '操作描述',
    ip_address VARCHAR(45) COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL,
    FOREIGN KEY (campus_id) REFERENCES campuses(id) ON DELETE SET NULL,
    INDEX idx_user_id (user_id),
    INDEX idx_action_type (action_type),
    INDEX idx_created_at (created_at)
);
```

#### 2.2.10 许可证管理表

**许可证表 (licenses)**
```sql
CREATE TABLE licenses (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    license_key VARCHAR(128) UNIQUE NOT NULL COMMENT '许可证密钥',
    device_id VARCHAR(128) UNIQUE COMMENT '设备ID',
    campus_id BIGINT NOT NULL COMMENT '校区ID',
    start_date DATE NOT NULL COMMENT '开始日期',
    end_date DATE NOT NULL COMMENT '结束日期',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否激活',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (campus_id) REFERENCES campuses(id) ON DELETE CASCADE
);
```

## 3. 接口设计

### 3.1 RESTful API 设计原则

- 使用HTTP动词表示操作：GET（查询）、POST（创建）、PUT（更新）、DELETE（删除）
- 使用HTTP状态码表示结果
- 统一的响应格式
- 版本控制：/api/v1/

### 3.2 核心API接口

#### 3.2.1 用户认证接口
```
POST /api/v1/auth/login/          # 用户登录
POST /api/v1/auth/logout/         # 用户登出
POST /api/v1/auth/register/       # 用户注册
POST /api/v1/auth/password/reset/ # 密码重置
```

#### 3.2.2 用户管理接口
```
GET    /api/v1/users/profile/     # 获取个人信息
PUT    /api/v1/users/profile/     # 更新个人信息
GET    /api/v1/coaches/           # 查询教练列表
GET    /api/v1/coaches/{id}/      # 获取教练详情
POST   /api/v1/coaches/apply/     # 申请成为教练
```

#### 3.2.3 课程管理接口
```
GET    /api/v1/bookings/          # 获取预约列表
POST   /api/v1/bookings/          # 创建预约
PUT    /api/v1/bookings/{id}/     # 更新预约
DELETE /api/v1/bookings/{id}/     # 取消预约
GET    /api/v1/schedules/         # 获取课表
```

#### 3.2.4 支付接口
```
POST   /api/v1/payments/recharge/  # 账户充值
GET    /api/v1/payments/history/   # 支付历史
POST   /api/v1/payments/wechat/    # 微信支付
POST   /api/v1/payments/alipay/    # 支付宝支付
```

### 3.3 响应格式标准

```json
{
    "code": 200,
    "message": "success",
    "data": {
        // 具体数据
    },
    "timestamp": "2025-01-01T12:00:00Z"
}
```

## 4. 安全设计

### 4.1 认证与授权
- JWT Token认证
- 基于角色的权限控制（RBAC）
- 接口权限验证

### 4.2 数据安全
- 密码BCrypt加密
- 敏感数据加密存储
- SQL注入防护
- XSS攻击防护

### 4.3 网络安全
- HTTPS传输加密
- CSRF防护
- 请求频率限制

## 5. 性能优化设计

### 5.1 数据库优化
- 合理的索引设计
- 查询优化
- 连接池配置
- 读写分离（可选）

### 5.2 缓存策略
- Redis缓存热点数据
- 页面缓存
- 查询结果缓存

### 5.3 前端优化
- 静态资源压缩
- CDN加速
- 懒加载

## 6. 部署架构

### 6.1 单机部署
```
┌─────────────────────────────────────┐
│              服务器                  │
│  ┌─────────────────────────────────┐ │
│  │           Nginx                 │ │
│  └─────────────────────────────────┘ │
│  ┌─────────────────────────────────┐ │
│  │      Django + Gunicorn          │ │
│  └─────────────────────────────────┘ │
│  ┌─────────────────────────────────┐ │
│  │           MySQL                 │ │
│  └─────────────────────────────────┘ │
│  ┌─────────────────────────────────┐ │
│  │           Redis                 │ │
│  └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

### 6.2 配置要求
- **操作系统**：Ubuntu 20.04 LTS 或 CentOS 8
- **内存**：最小4GB，推荐8GB
- **存储**：最小50GB SSD
- **网络**：100Mbps带宽

## 7. 监控与日志

### 7.1 系统监控
- 服务器性能监控
- 数据库性能监控
- 应用程序监控

### 7.2 日志管理
- 应用日志
- 访问日志
- 错误日志
- 操作审计日志

---

**文档版本**：V1.0  
**编写日期**：2025年1月  
**编写人员**：开发团队  
**审核状态**：待审核