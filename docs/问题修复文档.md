# 问题修复文档

## 取消申请功能错误修复

### 问题描述
- **错误信息**: `'User' object has no attribute 'user'`
- **发生时间**: 2024年1月
- **影响功能**: 学员/教练提交取消申请功能

### 问题原因
在之前修复确认预约功能时，修改了 `Booking` 模型中的 `coach` 属性定义：
- 原来返回: `self.relation.coach`
- 错误修改为: `self.relation.coach.user`

由于 `CoachStudentRelation` 模型中的 `coach` 字段本身就是 `ForeignKey` 到 `User` 模型，所以 `self.relation.coach` 已经是 `User` 对象，再访问 `.user` 属性会导致错误。

### 修复方案
1. **修复 coach 属性定义**
   - 文件: `reservations/models.py`
   - 行数: 247
   - 修改: 将 `return self.relation.coach.user` 改回 `return self.relation.coach`

2. **修复 can_cancel 方法中的查询条件**
   - 文件: `reservations/models.py`
   - 行数: 274
   - 修改: 将 `Q(relation__coach__user=user)` 改回 `Q(relation__coach=user)`

### 测试结果
- 前端页面正常加载
- 后端服务器无错误日志
- 取消申请功能恢复正常

### 经验教训
在修改模型属性时，需要检查所有使用该属性的地方，确保修改的一致性。特别是涉及外键关系时，要明确字段的实际类型。

---

## 前端状态显示修复

### 问题描述
- **问题现象**: 前端页面显示预约状态为"已确认"，但实际状态应为"待审核取消"
- **发生时间**: 2025年1月
- **影响功能**: 预约状态显示功能，涉及所有前端组件

### 问题原因
前端所有组件中的状态映射函数缺少对 `pending_cancellation` 状态的处理：
- 后端模型已定义 `pending_cancellation` 状态
- 后端API能正确返回该状态
- 但前端状态映射函数未包含该状态的映射逻辑，导致显示为默认状态

### 修复方案
修复了以下前端组件中的状态映射函数：

1. **BookingDetail.vue**
   - 文件路径: `frontend/src/components/BookingDetail.vue`
   - 修复内容: 在 `getStatusTagType` 和 `getStatusText` 函数中添加 `pending_cancellation` 状态映射
   - 状态类型: `warning`
   - 显示文本: `待审核取消`

2. **Reservations.vue**
   - 文件路径: `frontend/src/views/Reservations.vue`
   - 修复内容: 在 `getStatusType` 和 `getStatusText` 函数中添加状态映射
   - 状态类型: `warning`
   - 显示文本: `待审核取消`

3. **CoachSchedule.vue**
   - 文件路径: `frontend/src/components/CoachSchedule.vue`
   - 修复内容: 
     - 删除重复的 `getStatusTagType` 函数定义
     - 在保留的函数中添加 `pending_cancellation` 状态映射
   - 状态类型: `warning`
   - 显示文本: `待审核取消`

4. **StudentSchedule.vue**
   - 文件路径: `frontend/src/components/StudentSchedule.vue`
   - 修复内容: 在 `getStatusText` 和 `getStatusTagType` 函数中添加状态映射
   - 状态类型: `warning`
   - 显示文本: `待审核取消`

### 测试结果
- 创建测试数据（预约ID 64设置为 `pending_cancellation` 状态）
- 前端页面正确显示"待审核取消"状态
- 状态标签显示为橙色警告样式（warning类型）
- 所有相关组件状态显示一致

### 经验教训
1. 在后端添加新状态时，需要同步更新前端所有相关组件的状态映射函数
2. 前端状态映射应保持一致性，避免不同组件显示不同的状态文本
3. 测试时应创建实际数据验证功能，而不仅仅依赖代码审查