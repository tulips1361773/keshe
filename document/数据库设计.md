### 3.2 数据表设计

#### 3.2.1 用户相关表

**用户基础表 (accounts_user)**
```sql
CREATE TABLE accounts_user (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    password VARCHAR(128) NOT NULL COMMENT '密码',
    last_login DATETIME COMMENT '最后登录时间',
    is_superuser BOOLEAN DEFAULT FALSE COMMENT '是否为超级用户',
    username VARCHAR(150) UNIQUE NOT NULL COMMENT '用户名',
    first_name VARCHAR(150) COMMENT '名字',
    last_name VARCHAR(150) COMMENT '姓氏',
    email VARCHAR(254) COMMENT '邮箱',
    is_staff BOOLEAN DEFAULT FALSE COMMENT '是否为管理员',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否激活',
    date_joined DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '注册时间',
    -- 扩展字段
    user_type ENUM('student', 'coach', 'campus_admin', 'super_admin') NOT NULL COMMENT '用户类型',
    phone VARCHAR(11) COMMENT '手机号码',
    avatar VARCHAR(100) COMMENT '头像',
    real_name VARCHAR(100) COMMENT '真实姓名',
    id_card VARCHAR(18) COMMENT '身份证号',
    birth_date DATE COMMENT '出生日期',
    gender ENUM('M', 'F', 'O') COMMENT '性别',
    address VARCHAR(200) COMMENT '地址',
    emergency_contact VARCHAR(100) COMMENT '紧急联系人',
    emergency_phone VARCHAR(11) COMMENT '紧急联系电话',
    is_active_member BOOLEAN DEFAULT TRUE COMMENT '是否活跃用户',
    registration_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '注册时间',
    last_login_ip INET COMMENT '最后登录IP'
);
```

**用户扩展资料表 (accounts_user_profile)**
```sql
CREATE TABLE accounts_user_profile (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT UNIQUE NOT NULL COMMENT '用户ID',
    bio TEXT COMMENT '个人简介',
    skills TEXT COMMENT '技能特长',
    experience_years INT UNSIGNED DEFAULT 0 COMMENT '经验年数',
    certification TEXT COMMENT '资格证书',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (user_id) REFERENCES accounts_user(id) ON DELETE CASCADE
);
```

#### 3.2.2 校区管理表

**校区表 (campus_campus)**
```sql
CREATE TABLE campus_campus (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) UNIQUE NOT NULL COMMENT '校区名称',
    code VARCHAR(20) UNIQUE NOT NULL COMMENT '校区编码',
    campus_type ENUM('center', 'branch') DEFAULT 'branch' COMMENT '校区类型',
    address TEXT NOT NULL COMMENT '校区地址',
    contact_person VARCHAR(50) DEFAULT '待填写' COMMENT '联系人',
    phone VARCHAR(20) NOT NULL COMMENT '联系电话',
    email VARCHAR(254) COMMENT '邮箱',
    manager_id BIGINT COMMENT '校区管理员ID',
    parent_campus_id BIGINT COMMENT '上级校区ID',
    description TEXT COMMENT '校区描述',
    facilities TEXT COMMENT '设施介绍',
    operating_hours VARCHAR(100) DEFAULT '09:00-21:00' COMMENT '营业时间',
    capacity INT UNSIGNED DEFAULT 100 COMMENT '容纳人数',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (manager_id) REFERENCES accounts_user(id),
    FOREIGN KEY (parent_campus_id) REFERENCES campus_campus(id)
);
```

**校区分区表 (campus_area)**
```sql
CREATE TABLE campus_area (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    campus_id BIGINT NOT NULL COMMENT '所属校区ID',
    name VARCHAR(50) NOT NULL COMMENT '分区名称',
    area_type ENUM('training', 'rest', 'equipment', 'office', 'reception', 'other') NOT NULL COMMENT '分区类型',
    description TEXT COMMENT '分区描述',
    capacity INT UNSIGNED DEFAULT 10 COMMENT '容纳人数',
    equipment_list TEXT COMMENT '设备清单',
    is_available BOOLEAN DEFAULT TRUE COMMENT '是否可用',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (campus_id) REFERENCES campus_campus(id) ON DELETE CASCADE,
    UNIQUE KEY uk_campus_area (campus_id, name)
);
```

**校区学员关联表 (campus_student)**
```sql
CREATE TABLE campus_student (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    campus_id BIGINT NOT NULL COMMENT '校区ID',
    student_id BIGINT NOT NULL COMMENT '学员ID',
    enrollment_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '入学时间',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否活跃',
    notes TEXT COMMENT '备注',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    FOREIGN KEY (campus_id) REFERENCES campus_campus(id) ON DELETE CASCADE,
    FOREIGN KEY (student_id) REFERENCES accounts_user(id) ON DELETE CASCADE,
    UNIQUE KEY uk_campus_student (campus_id, student_id)
);
```

**校区教练关联表 (campus_coach)**
```sql
CREATE TABLE campus_coach (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    campus_id BIGINT NOT NULL COMMENT '校区ID',
    coach_id BIGINT NOT NULL COMMENT '教练ID',
    hire_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '入职时间',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否在职',
    specialties TEXT COMMENT '专业特长',
    max_students INT UNSIGNED DEFAULT 20 COMMENT '最大学员数',
    hourly_rate DECIMAL(8,2) DEFAULT 0.00 COMMENT '时薪',
    notes TEXT COMMENT '备注',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    FOREIGN KEY (campus_id) REFERENCES campus_campus(id) ON DELETE CASCADE,
    FOREIGN KEY (coach_id) REFERENCES accounts_user(id) ON DELETE CASCADE,
    UNIQUE KEY uk_campus_coach (campus_id, coach_id)
);
```

#### 3.2.3 课程管理表

**课程表 (courses_course)**
```sql
CREATE TABLE courses_course (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL COMMENT '课程名称',
    description TEXT COMMENT '课程描述',
    coach_id BIGINT NOT NULL COMMENT '教练ID',
    campus_id BIGINT NOT NULL COMMENT '校区ID',
    course_type ENUM('group', 'private', 'trial') DEFAULT 'group' COMMENT '课程类型',
    skill_level ENUM('beginner', 'intermediate', 'advanced') DEFAULT 'beginner' COMMENT '技能水平',
    max_students INT UNSIGNED DEFAULT 10 COMMENT '最大学员数',
    duration_minutes INT UNSIGNED DEFAULT 60 COMMENT '课程时长(分钟)',
    price_per_session DECIMAL(8,2) DEFAULT 0.00 COMMENT '单次课程价格',
    total_sessions INT UNSIGNED DEFAULT 1 COMMENT '总课时数',
    status ENUM('draft', 'published', 'suspended', 'completed') DEFAULT 'draft' COMMENT '课程状态',
    start_date DATE NOT NULL COMMENT '开始日期',
    end_date DATE NOT NULL COMMENT '结束日期',
    requirements TEXT COMMENT '课程要求',
    equipment_needed TEXT COMMENT '所需器材',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (coach_id) REFERENCES accounts_user(id) ON DELETE CASCADE,
    FOREIGN KEY (campus_id) REFERENCES campus_campus(id) ON DELETE CASCADE
);
```

**课程时间表 (courses_schedule)**
```sql
CREATE TABLE courses_schedule (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    course_id BIGINT NOT NULL COMMENT '课程ID',
    weekday INT NOT NULL COMMENT '星期(0-6)',
    start_time TIME NOT NULL COMMENT '开始时间',
    end_time TIME NOT NULL COMMENT '结束时间',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    FOREIGN KEY (course_id) REFERENCES courses_course(id) ON DELETE CASCADE,
    UNIQUE KEY uk_course_schedule (course_id, weekday, start_time)
);
```

**课程报名表 (courses_courseenrollment)**
```sql
CREATE TABLE courses_courseenrollment (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    course_id BIGINT NOT NULL COMMENT '课程ID',
    student_id BIGINT NOT NULL COMMENT '学员ID',
    enrollment_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '报名时间',
    status ENUM('pending', 'confirmed', 'cancelled', 'completed') DEFAULT 'pending' COMMENT '报名状态',
    payment_status ENUM('unpaid', 'partial', 'paid', 'refunded') DEFAULT 'unpaid' COMMENT '支付状态',
    total_fee DECIMAL(10,2) DEFAULT 0.00 COMMENT '总费用',
    paid_amount DECIMAL(10,2) DEFAULT 0.00 COMMENT '已付金额',
    notes TEXT COMMENT '备注',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否活跃',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (course_id) REFERENCES courses_course(id) ON DELETE CASCADE,
    FOREIGN KEY (student_id) REFERENCES accounts_user(id) ON DELETE CASCADE,
    UNIQUE KEY uk_course_student (course_id, student_id)
);
```
#### 3.2.4 预约管理表

**师生关系表 (reservations_coach_student_relation)**
```sql
CREATE TABLE reservations_coach_student_relation (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    coach_id BIGINT NOT NULL COMMENT '教练ID',
    student_id BIGINT NOT NULL COMMENT '学员ID',
    status ENUM('pending', 'approved', 'rejected', 'terminated') DEFAULT 'pending' COMMENT '关系状态',
    applied_by ENUM('student', 'coach') NOT NULL COMMENT '申请方',
    applied_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '申请时间',
    processed_at DATETIME COMMENT '处理时间',
    terminated_at DATETIME COMMENT '终止时间',
    notes TEXT COMMENT '备注',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    FOREIGN KEY (coach_id) REFERENCES accounts_user(id) ON DELETE CASCADE,
    FOREIGN KEY (student_id) REFERENCES accounts_user(id) ON DELETE CASCADE,
    UNIQUE KEY uk_coach_student (coach_id, student_id)
);
```

**球台表 (reservations_table)**
```sql
CREATE TABLE reservations_table (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    campus_id BIGINT NOT NULL COMMENT '所属校区ID',
    number VARCHAR(10) NOT NULL COMMENT '球台编号',
    name VARCHAR(50) COMMENT '球台名称',
    status ENUM('available', 'occupied', 'maintenance', 'disabled') DEFAULT 'available' COMMENT '球台状态',
    description TEXT COMMENT '球台描述',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (campus_id) REFERENCES campus_campus(id) ON DELETE CASCADE,
    UNIQUE KEY uk_campus_table (campus_id, number)
);
```

**预约表 (reservations_booking)**
```sql
CREATE TABLE reservations_booking (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    relation_id BIGINT NOT NULL COMMENT '师生关系ID',
    table_id BIGINT NOT NULL COMMENT '球台ID',
    start_time DATETIME NOT NULL COMMENT '开始时间',
    end_time DATETIME NOT NULL COMMENT '结束时间',
    duration_hours DECIMAL(3,1) NOT NULL COMMENT '时长（小时）',
    total_fee DECIMAL(10,2) NOT NULL COMMENT '总费用',
    status ENUM('pending', 'confirmed', 'pending_cancellation', 'completed', 'cancelled') DEFAULT 'pending' COMMENT '预约状态',
    payment_status ENUM('unpaid', 'partial', 'paid', 'refunded') DEFAULT 'unpaid' COMMENT '支付状态',
    confirmed_at DATETIME COMMENT '确认时间',
    cancelled_at DATETIME COMMENT '取消时间',
    cancel_reason TEXT COMMENT '取消原因',
    cancelled_by_id BIGINT COMMENT '取消人ID',
    notes TEXT COMMENT '备注',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (relation_id) REFERENCES reservations_coach_student_relation(id) ON DELETE CASCADE,
    FOREIGN KEY (table_id) REFERENCES reservations_table(id) ON DELETE CASCADE,
    FOREIGN KEY (cancelled_by_id) REFERENCES accounts_user(id)
);
```

#### 3.2.5 比赛管理表

**比赛表 (competitions_competition)**
```sql
CREATE TABLE competitions_competition (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(200) NOT NULL COMMENT '比赛标题',
    description TEXT COMMENT '比赛描述',
    organizer_id BIGINT NOT NULL COMMENT '组织者ID',
    campus_id BIGINT NOT NULL COMMENT '举办校区ID',
    competition_type ENUM('individual', 'team', 'mixed') DEFAULT 'individual' COMMENT '比赛类型',
    skill_level ENUM('beginner', 'intermediate', 'advanced', 'professional') DEFAULT 'beginner' COMMENT '技能水平',
    max_participants INT UNSIGNED DEFAULT 32 COMMENT '最大参赛人数',
    registration_start DATETIME NOT NULL COMMENT '报名开始时间',
    registration_end DATETIME NOT NULL COMMENT '报名结束时间',
    competition_start DATETIME NOT NULL COMMENT '比赛开始时间',
    competition_end DATETIME NOT NULL COMMENT '比赛结束时间',
    registration_fee DECIMAL(8,2) DEFAULT 0.00 COMMENT '报名费',
    prize_pool DECIMAL(10,2) DEFAULT 0.00 COMMENT '奖金池',
    rules TEXT COMMENT '比赛规则',
    requirements TEXT COMMENT '参赛要求',
    status ENUM('draft', 'published', 'registration_open', 'registration_closed', 'ongoing', 'completed', 'cancelled') DEFAULT 'draft' COMMENT '比赛状态',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (organizer_id) REFERENCES accounts_user(id) ON DELETE CASCADE,
    FOREIGN KEY (campus_id) REFERENCES campus_campus(id) ON DELETE CASCADE
);
```

**比赛报名表 (competitions_competitionregistration)**
```sql
CREATE TABLE competitions_competitionregistration (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    competition_id BIGINT NOT NULL COMMENT '比赛ID',
    participant_id BIGINT NOT NULL COMMENT '参赛者ID',
    group_type ENUM('A', 'B', 'C', 'D') NOT NULL COMMENT '参赛组别',
    status ENUM('pending', 'confirmed', 'cancelled') DEFAULT 'pending' COMMENT '报名状态',
    registration_fee DECIMAL(8,2) DEFAULT 0.00 COMMENT '报名费',
    payment_status ENUM('unpaid', 'paid', 'refunded') DEFAULT 'unpaid' COMMENT '支付状态',
    notes TEXT COMMENT '备注',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (competition_id) REFERENCES competitions_competition(id) ON DELETE CASCADE,
    FOREIGN KEY (participant_id) REFERENCES accounts_user(id) ON DELETE CASCADE,
    UNIQUE KEY uk_competition_participant (competition_id, participant_id)
);
```

**比赛分组表 (competitions_competitiongroup)**
```sql
CREATE TABLE competitions_competitiongroup (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    competition_id BIGINT NOT NULL COMMENT '比赛ID',
    group_name VARCHAR(50) NOT NULL COMMENT '分组名称',
    group_type ENUM('A', 'B', 'C', 'D') NOT NULL COMMENT '组别类型',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    FOREIGN KEY (competition_id) REFERENCES competitions_competition(id) ON DELETE CASCADE,
    UNIQUE KEY uk_competition_group (competition_id, group_name)
);
```

**比赛分组成员表 (competitions_competitiongroupmember)**
```sql
CREATE TABLE competitions_competitiongroupmember (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    group_id BIGINT NOT NULL COMMENT '分组ID',
    participant_id BIGINT NOT NULL COMMENT '参赛者ID',
    seed_number INT COMMENT '种子号',
    FOREIGN KEY (group_id) REFERENCES competitions_competitiongroup(id) ON DELETE CASCADE,
    FOREIGN KEY (participant_id) REFERENCES accounts_user(id) ON DELETE CASCADE,
    UNIQUE KEY uk_group_participant (group_id, participant_id)
);
```

**比赛结果表 (competitions_competitionresult)**
```sql
CREATE TABLE competitions_competitionresult (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    competition_id BIGINT NOT NULL COMMENT '比赛ID',
    participant_id BIGINT NOT NULL COMMENT '参赛者ID',
    group_type ENUM('A', 'B', 'C', 'D') NOT NULL COMMENT '参赛组别',
    matches_played INT DEFAULT 0 COMMENT '比赛场次',
    matches_won INT DEFAULT 0 COMMENT '获胜场次',
    matches_lost INT DEFAULT 0 COMMENT '失败场次',
    total_score_for INT DEFAULT 0 COMMENT '总得分',
    total_score_against INT DEFAULT 0 COMMENT '总失分',
    group_rank INT COMMENT '组内排名',
    overall_rank INT COMMENT '总排名',
    award VARCHAR(100) COMMENT '获得奖项',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (competition_id) REFERENCES competitions_competition(id) ON DELETE CASCADE,
    FOREIGN KEY (participant_id) REFERENCES accounts_user(id) ON DELETE CASCADE,
    UNIQUE KEY uk_competition_participant_result (competition_id, participant_id)
);
```
    #### 3.2.6 支付管理表

**支付方式表 (payments_method)**
```sql
CREATE TABLE payments_method (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL COMMENT '支付方式名称',
    method_type ENUM('cash', 'wechat', 'alipay', 'bank_card', 'credit_card', 'other') NOT NULL COMMENT '支付类型',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    description TEXT COMMENT '描述',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间'
);
```

**支付记录表 (payments_payment)**
```sql
CREATE TABLE payments_payment (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    payment_id VARCHAR(50) UNIQUE NOT NULL COMMENT '支付单号',
    user_id BIGINT NOT NULL COMMENT '支付用户ID',
    enrollment_id BIGINT COMMENT '关联报名ID',
    payment_type ENUM('course_fee', 'registration_fee', 'equipment_fee', 'membership_fee', 'penalty_fee', 'other') DEFAULT 'course_fee' COMMENT '支付类型',
    amount DECIMAL(10,2) NOT NULL COMMENT '支付金额',
    payment_method_id BIGINT COMMENT '支付方式ID',
    status ENUM('pending', 'processing', 'completed', 'failed', 'cancelled', 'refunded') DEFAULT 'pending' COMMENT '支付状态',
    transaction_id VARCHAR(100) COMMENT '第三方交易号',
    description TEXT COMMENT '支付描述',
    paid_at DATETIME COMMENT '支付时间',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (user_id) REFERENCES accounts_user(id) ON DELETE CASCADE,
    FOREIGN KEY (payment_method_id) REFERENCES payments_method(id) ON DELETE SET NULL,
    FOREIGN KEY (enrollment_id) REFERENCES courses_courseenrollment(id) ON DELETE CASCADE
);
```

**退款记录表 (payments_refund)**
```sql
CREATE TABLE payments_refund (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    refund_id VARCHAR(50) UNIQUE NOT NULL COMMENT '退款单号',
    payment_id BIGINT NOT NULL COMMENT '原支付记录ID',
    amount DECIMAL(10,2) NOT NULL COMMENT '退款金额',
    reason ENUM('course_cancelled', 'student_request', 'schedule_conflict', 'quality_issue', 'other') NOT NULL COMMENT '退款原因',
    status ENUM('pending', 'approved', 'rejected', 'processing', 'completed', 'failed') DEFAULT 'pending' COMMENT '退款状态',
    description TEXT COMMENT '退款描述',
    processed_by_id BIGINT COMMENT '处理人ID',
    processed_at DATETIME COMMENT '处理时间',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (payment_id) REFERENCES payments_payment(id) ON DELETE CASCADE,
    FOREIGN KEY (processed_by_id) REFERENCES accounts_user(id) ON DELETE SET NULL
);
```

**账户交易表 (payments_accounttransaction)**
```sql
CREATE TABLE payments_accounttransaction (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    transaction_id VARCHAR(50) UNIQUE NOT NULL COMMENT '交易单号',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    transaction_type ENUM('recharge', 'consume', 'refund', 'withdraw', 'transfer', 'bonus', 'penalty') NOT NULL COMMENT '交易类型',
    amount DECIMAL(10,2) NOT NULL COMMENT '交易金额',
    balance_before DECIMAL(10,2) NOT NULL COMMENT '交易前余额',
    balance_after DECIMAL(10,2) NOT NULL COMMENT '交易后余额',
    related_payment_id BIGINT COMMENT '关联支付记录ID',
    description TEXT COMMENT '交易描述',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    FOREIGN KEY (user_id) REFERENCES accounts_user(id) ON DELETE CASCADE,
    FOREIGN KEY (related_payment_id) REFERENCES payments_payment(id) ON DELETE SET NULL
);
```

#### 3.2.7 通知管理表

**通知表 (notifications)**
```sql
CREATE TABLE notifications (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    recipient_id BIGINT NOT NULL COMMENT '接收人ID',
    sender_id BIGINT COMMENT '发送人ID',
    title VARCHAR(200) NOT NULL COMMENT '消息标题',
    message TEXT NOT NULL COMMENT '消息内容',
    message_type ENUM('system', 'booking', 'payment', 'competition', 'evaluation') DEFAULT 'system' COMMENT '消息类型',
    is_read BOOLEAN DEFAULT FALSE COMMENT '是否已读',
    data JSON COMMENT '附加数据',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    read_at DATETIME COMMENT '阅读时间',
    FOREIGN KEY (recipient_id) REFERENCES accounts_user(id) ON DELETE CASCADE,
    FOREIGN KEY (sender_id) REFERENCES accounts_user(id) ON DELETE SET NULL,
    INDEX idx_recipient_read (recipient_id, is_read),
    INDEX idx_message_type (message_type),
    INDEX idx_created_at (created_at)
);
```

#### 3.2.8 日志管理表

**系统操作日志表 (logs_systemlog)**
```sql
CREATE TABLE logs_systemlog (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT COMMENT '操作用户ID',
    action_type ENUM('create', 'update', 'delete', 'login', 'logout', 'approve', 'reject', 'cancel', 'confirm', 'payment', 'refund', 'register', 'other') NOT NULL COMMENT '操作类型',
    resource_type ENUM('user', 'campus', 'student', 'coach', 'booking', 'course', 'payment', 'competition', 'notification', 'system', 'other') NOT NULL COMMENT '资源类型',
    resource_id VARCHAR(100) COMMENT '资源ID',
    resource_name VARCHAR(200) COMMENT '资源名称',
    description TEXT NOT NULL COMMENT '操作描述',
    ip_address INET COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理',
    extra_data JSON COMMENT '额外数据',
    campus_id BIGINT COMMENT '所属校区ID',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
    FOREIGN KEY (user_id) REFERENCES accounts_user(id) ON DELETE SET NULL,
    FOREIGN KEY (campus_id) REFERENCES campus_campus(id) ON DELETE SET NULL,
    INDEX idx_user_action (user_id, action_type),
    INDEX idx_resource (resource_type, resource_id),
    INDEX idx_created_at (created_at)
);
```

**登录日志表 (logs_loginlog)**
```sql
CREATE TABLE logs_loginlog (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT COMMENT '用户ID',
    username VARCHAR(150) NOT NULL COMMENT '用户名',
    login_type ENUM('web', 'mobile', 'api', 'admin') DEFAULT 'web' COMMENT '登录类型',
    ip_address INET COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理',
    location VARCHAR(200) COMMENT '登录地点',
    device_info VARCHAR(500) COMMENT '设备信息',
    success BOOLEAN DEFAULT TRUE COMMENT '是否成功',
    failure_reason VARCHAR(200) COMMENT '失败原因',
    session_key VARCHAR(40) COMMENT '会话密钥',
    logout_time DATETIME COMMENT '登出时间',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '登录时间',
    FOREIGN KEY (user_id) REFERENCES accounts_user(id) ON DELETE SET NULL,
    INDEX idx_user_login (user_id, created_at),
    INDEX idx_ip_address (ip_address),
    INDEX idx_success (success)
### 3.3 数据库关系说明

#### 3.3.1 核心关系
1. **用户与角色关系**：用户表通过user_type字段区分管理员、教练、学员等角色
2. **校区与用户关系**：教练和学员都关联到特定校区
3. **师生关系**：通过reservations_coach_student_relation表建立教练与学员的关系
4. **预约关系**：预约基于师生关系和球台资源进行
5. **课程关系**：课程与校区关联，学员可报名参加课程
6. **支付关系**：支付记录关联用户、课程报名或预约等业务对象

#### 3.3.2 数据完整性约束
1. **外键约束**：确保关联数据的一致性
2. **唯一性约束**：防止重复数据（如师生关系、比赛报名等）
3. **检查约束**：确保数据的有效性（如时间范围、金额等）
4. **级联删除**：合理设置级联删除策略，保证数据清理的完整性

## 4. 系统架构设计
    actual_start_time DATETIME COMMENT '实际开始时间',
    actual_end_time DATETIME COMMENT '实际结束时间',
    player1_score INT DEFAULT 0 COMMENT '选手1得分',
    player2_score INT DEFAULT 0 COMMENT '选手2得分',
    winner_id BIGINT COMMENT '获胜者ID',
    status ENUM('scheduled', 'in_progress', 'completed', 'cancelled') DEFAULT 'scheduled' COMMENT '比赛状态',
    notes TEXT COMMENT '备注',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    FOREIGN KEY (competition_id) REFERENCES competitions_competition(id) ON DELETE CASCADE,
    FOREIGN KEY (group_id) REFERENCES competitions_competitiongroup(id) ON DELETE CASCADE,
    FOREIGN KEY (player1_id) REFERENCES auth_user(id) ON DELETE CASCADE,
    FOREIGN KEY (player2_id) REFERENCES auth_user(id) ON DELETE CASCADE,
    FOREIGN KEY (winner_id) REFERENCES auth_user(id) ON DELETE SET NULL
);
```

**比赛结果表 (competitions_competitionresult)**
```sql
CREATE TABLE competitions_competitionresult (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    competition_id BIGINT NOT NULL COMMENT '比赛ID',
    participant_id BIGINT NOT NULL COMMENT '参赛者ID',
    group_type ENUM('A', 'B', 'C') NOT NULL COMMENT '参赛组别',
    matches_played INT DEFAULT 0 COMMENT '比赛场次',
    matches_won INT DEFAULT 0 COMMENT '获胜场次',
    matches_lost INT DEFAULT 0 COMMENT '失败场次',
    total_score_for INT DEFAULT 0 COMMENT '总得分',
    total_score_against INT DEFAULT 0 COMMENT '总失分',
    group_rank INT COMMENT '组内排名',
    overall_rank INT COMMENT '总排名',
    award VARCHAR(100) COMMENT '获得奖项',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (competition_id) REFERENCES competitions_competition(id) ON DELETE CASCADE,
    FOREIGN KEY (participant_id) REFERENCES auth_user(id) ON DELETE CASCADE,
    UNIQUE KEY uk_competition_participant_result (competition_id, participant_id)
);
```
```sql
CREATE TABLE competition_registrations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    student_id BIGINT NOT NULL COMMENT '学员ID',
    group_id BIGINT NOT NULL COMMENT '组别ID',
    registration_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    payment_status ENUM('pending', 'paid') DEFAULT 'pending',
    FOREIGN KEY (student_id) REFERENCES students(id) ON DELETE CASCADE,
    FOREIGN KEY (group_id) REFERENCES competition_groups(id) ON DELETE CASCADE,
    UNIQUE KEY uk_student_group (student_id, group_id)
);
```

#### 2.2.7 评价系统表

**课程评价表 (course_evaluations)**
```sql
CREATE TABLE course_evaluations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    booking_id BIGINT NOT NULL COMMENT '预约ID',
    evaluator_id BIGINT NOT NULL COMMENT '评价人ID',
    evaluator_type ENUM('student', 'coach') NOT NULL COMMENT '评价人类型',
    content TEXT NOT NULL COMMENT '评价内容',
    rating INT COMMENT '评分（1-5）',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (booking_id) REFERENCES bookings(id) ON DELETE CASCADE,
    FOREIGN KEY (evaluator_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### 2.2.8 消息通知表

**系统消息表 (notifications)**
```sql
CREATE TABLE notifications (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    recipient_id BIGINT NOT NULL COMMENT '接收人ID',
    sender_id BIGINT COMMENT '发送人ID',
    title VARCHAR(200) NOT NULL COMMENT '消息标题',
    content TEXT NOT NULL COMMENT '消息内容',
    message_type ENUM('system', 'booking', 'payment', 'competition', 'evaluation') NOT NULL COMMENT '消息类型',
    is_read BOOLEAN DEFAULT FALSE COMMENT '是否已读',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (recipient_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (sender_id) REFERENCES users(id) ON DELETE SET NULL,
    INDEX idx_recipient_unread (recipient_id, is_read)
);
```

#### 2.2.9 系统日志表

**操作日志表 (system_logs)**
```sql
CREATE TABLE system_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT COMMENT '操作用户ID',
    campus_id BIGINT COMMENT '校区ID',
    action_type VARCHAR(50) NOT NULL COMMENT '操作类型',
    action_description TEXT NOT NULL COMMENT '操作描述',
    ip_address VARCHAR(45) COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL,
    FOREIGN KEY (campus_id) REFERENCES campuses(id) ON DELETE SET NULL,
    INDEX idx_user_id (user_id),
    INDEX idx_action_type (action_type),
    INDEX idx_created_at (created_at)
);
```

#### 2.2.10 许可证管理表

**许可证表 (licenses)**
```sql
CREATE TABLE licenses (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    license_key VARCHAR(128) UNIQUE NOT NULL COMMENT '许可证密钥',
    device_id VARCHAR(128) UNIQUE COMMENT '设备ID',
    campus_id BIGINT NOT NULL COMMENT '校区ID',
    start_date DATE NOT NULL COMMENT '开始日期',
    end_date DATE NOT NULL COMMENT '结束日期',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否激活',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (campus_id) REFERENCES campuses(id) ON DELETE CASCADE
);
```
