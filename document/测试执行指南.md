# 乒乓球培训管理系统 - 测试执行指南
体的执行操作和实践指导。

## 最佳实践

### 1. 测试执行顺序

1. **环境准备**：安装依赖、配置数据库
2. **数据准备**：创建测试数据
3. **单元测试**：验证基础功能
4. **功能测试**：验证业务流程
5. **专项测试**：验证特定功能
6. **数据清理**：清理测试数据

## 测试环境准备

### 1. 基础环境配置

```bash
# 1. 确保Python环境
python --version  # 需要Python 3.8+

# 2. 安装项目依赖
pip install -r requirements.txt

# 3. 配置数据库
python manage.py migrate

# 4. 验证Django服务器可以启动
python manage.py runserver 8000
```

### 2. 测试数据准备

```bash
# 创建完整的测试数据集
python run_tests.py --create-data

# 验证测试数据完整性
python run_tests.py --validate-data

# 查看测试数据索引
python run_tests.py --index
```
## 测试类型详解

### 1. 单元测试 (tests/test_unit.py)

**测试状态**：✅ 正常运行（已修复Django配置问题）

**执行命令**：
```bash
python run_tests.py --unit
# 或
python manage.py test tests.test_unit --verbosity=2
```

**测试内容**：18个测试用例，包括用户模型、校区模型、日志模型、预约模型、支付模型、通知模型等核心功能测试。

**预期结果**：所有测试用例通过，无错误输出

### 2. 功能测试 (tests/test_functional.py)

**测试状态**：✅ 正常运行（已修复数据完整性问题）

**执行命令**：
```bash
python run_tests.py --functional
# 或
python manage.py test tests.test_functional --verbosity=2
```

**测试内容**：16个测试用例，包括用户功能、预约功能、支付功能、教练功能、通知功能、系统管理功能等业务流程测试。

**预期结果**：所有测试用例通过，无错误输出

### 3. 专项测试

#### 教练选择功能测试
- **文件**：`test/test_coach_selection_backend.py`
- **功能**：教练查询、筛选、师生关系管理API测试
- **执行**：`cd test/ && python test_coach_selection_backend.py`

#### 日志模块测试
- **文件**：`logs/tests.py`
- **功能**：系统日志、登录日志功能测试
- **执行**：`python manage.py test logs.tests --verbosity=2`

## 测试数据管理

### TestDataManager类使用

```python
from tests.test_data import TestDataManager

# 创建测试数据管理器
manager = TestDataManager()

# 创建完整测试场景
scenario = manager.create_complete_test_scenario()

# 清理测试数据
manager.cleanup_test_data()

# 验证数据完整性
results, issues = manager.validate_test_data()
```

### 测试账户信息

测试数据创建后，可使用以下测试账户：

**学员账户**：
- 用户名：`backend_test_student`
- 密码：`testpass123`

**教练账户**：
- 用户名：`zhang_coach`
- 密码：`testpass123`

**管理员账户**：
- 用户名：`admin`
- 密码：`admin123`

## 测试报告分析

### 1. 测试通过率分析

```bash
# 生成详细报告
python run_tests.py --all --verbose

# 查看专项测试报告
cd test/
python final_test_summary.py
```


## 常见问题解决

### 1. 数据库相关问题

**问题**：`IntegrityError: NOT NULL constraint failed`
**解决**：
```bash
# 重新创建测试数据
python run_tests.py --clean-data
python run_tests.py --create-data
```

**问题**：`NoReverseMatch` URL错误
**解决**：检查URL配置和命名空间是否正确

### 2. 权限相关问题

**问题**：`PermissionDenied` 权限错误
**解决**：
```bash
# 确保测试用户具有正确的权限
python test/create_admin_and_test_data.py
```

### 3. 测试数据冲突

**问题**：测试数据重复或冲突
**解决**：
```bash
# 清理重复数据
python test/clean_test_data.py

# 重新创建标准测试数据
python run_tests.py --create-data
```

### 4. 服务器连接问题

**问题**：API测试连接失败
**解决**：
```bash
# 确保Django服务器运行
python manage.py runserver 8000

# 在另一个终端运行测试
python run_tests.py --all
```

## 测试数据管理详解

### 1. 统一测试数据管理工具

#### 1.1 使用run_tests.py统一入口

```bash
# 创建完整测试场景数据
python run_tests.py --create-data

# 清理所有测试数据
python run_tests.py --clean-data

# 验证数据完整性
python run_tests.py --validate-data

# 查看测试数据统计
python run_tests.py --index

# 生成测试报告
python run_tests.py --report
```

#### 1.2 专项数据管理脚本

**创建管理员和基础数据**：
```bash
# 创建超级管理员和基础测试数据
python test/create_admin_and_test_data.py

# 创建标准测试用户和教练
python test/create_test_data.py
```

**清理重复和冲突数据**：
```bash
# 清理重复的测试数据，重新创建标准数据
python test/clean_test_data.py
```

### 2. TestDataManager类详细使用

#### 2.1 基本使用方法

```python
from tests.test_data import TestDataManager

# 创建测试数据管理器
manager = TestDataManager()

# 创建完整测试场景（推荐）
scenario = manager.create_complete_test_scenario()
# 返回包含校区、管理员、学员、教练、球台、师生关系等完整数据

# 清理测试数据
manager.cleanup_test_data()

# 验证数据完整性
results, issues = manager.validate_test_data()
if issues:
    print("发现数据完整性问题:", issues)
else:
    print("数据验证通过")
```

#### 2.2 单独创建各类测试数据

```python
# 创建测试校区
campus = manager.create_test_campus(
    name="测试校区A",
    code="TESTA001",
    address="测试地址123号"
)
# 创建通知
notification = manager.create_test_notification(
    recipient=student,
    title='测试通知',
    content='这是一条测试通知'
)
``

#### 2.3 批量数据创建

```python
from tests.test_data import TestDataFactory

# 批量创建用户
students = TestDataFactory.create_batch_users(
    count=10,
    user_type='student',
    campus=campus
)

# 批量创建预约
bookings = TestDataFactory.create_batch_bookings(
    count=20,
    students=students,
    coaches=coaches,
    tables=tables
)
```

### 3. 测试数据验证和诊断

#### 3.1 数据完整性验证

```python
# 验证测试数据完整性
results, issues = manager.validate_test_data()

# 查看统计结果
print("数据统计:")
for key, count in results.items():
    print(f"- {key}: {count} 个")

#### 3.2 常见数据问题诊断

```bash
# 检查用户数据
python -c "
from accounts.models import User
print(f'总用户数: {User.objects.count()}')
print(f'学员数: {User.objects.filter(user_type=\"student\").count()}')
print(f'教练数: {User.objects.filter(user_type=\"coach\").count()}')
print(f'管理员数: {User.objects.filter(user_type=\"admin\").count()}')
"

# 检查预约数据
python -c "
from reservations.models import Booking
print(f'预约总数: {Booking.objects.count()}')
print(f'已确认预约: {Booking.objects.filter(status=\"confirmed\").count()}')
print(f'待确认预约: {Booking.objects.filter(status=\"pending\").count()}')
"
```



