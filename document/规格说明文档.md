# 乒乓球培训管理系统规格说明文档

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档名称 | 乒乓球培训管理系统规格说明文档 |
| 版本号 | v1.0 |
| 创建日期 | 2024年12月 |
| 最后更新 | 2024年12月 |
| 文档状态 | 正式版 |
| 编写人员 | 开发团队 |

## 目录

1. [项目概述](#1-项目概述)
2. [系统架构](#2-系统架构)
3. [功能需求规格](#3-功能需求规格)
4. [非功能需求规格](#4-非功能需求规格)
5. [数据库设计规格](#5-数据库设计规格)
6. [接口设计规格](#6-接口设计规格)
7. [用户界面设计规格](#7-用户界面设计规格)
8. [系统安全规格](#8-系统安全规格)
9. [性能规格](#9-性能规格)
10. [测试规格](#10-测试规格)
11. [部署规格](#11-部署规格)
12. [维护规格](#12-维护规格)

---

## 1. 项目概述

### 1.1 项目背景

随着乒乓球运动的普及和培训需求的增长，传统的培训管理方式已无法满足现代化管理的需求。本系统旨在为乒乓球培训机构提供一套完整的数字化管理解决方案，涵盖学员管理、教练管理、课程预约、支付管理、比赛组织等核心业务流程。

### 1.2 项目目标

- **提升管理效率**：通过数字化手段简化培训机构的日常管理工作
- **优化用户体验**：为学员和教练提供便捷的在线服务平台
- **规范业务流程**：建立标准化的培训管理流程和制度
- **数据驱动决策**：通过数据分析为管理决策提供支持

### 1.3 系统特色

- **多角色管理**：支持学员、教练、校区管理员、超级管理员四种用户角色
- **灵活预约系统**：支持多种预约模式和时间管理
- **完整支付体系**：集成线上线下多种支付方式
- **智能比赛管理**：自动化比赛分组和赛程安排
- **实时消息通知**：多渠道消息推送和通知机制

### 1.4 技术架构

- **后端框架**：Django 4.2 + Django REST Framework
- **数据库**：MySQL 8.0
- **前端技术**：HTML5 + CSS3 + JavaScript + Bootstrap
- **部署环境**：Linux + Nginx + uWSGI
- **开发工具**：PyCharm + Git + Postman

---

## 2. 系统架构

### 2.1 整体架构

系统采用经典的三层架构设计：

```
┌─────────────────────────────────────────┐
│              表现层 (Presentation)        │
│  Web界面 + REST API + 移动端适配          │
├─────────────────────────────────────────┤
│              业务逻辑层 (Business)        │
│  用户管理 + 课程管理 + 支付管理 + 比赛管理  │
├─────────────────────────────────────────┤
│              数据访问层 (Data Access)     │
│  Django ORM + MySQL数据库 + 缓存层       │
└─────────────────────────────────────────┘
```

### 2.2 模块架构

系统按功能模块进行组织：

- **accounts**：用户账户管理模块
- **campus**：校区管理模块
- **courses**：课程管理模块
- **reservations**：预约管理模块
- **payments**：支付管理模块
- **competitions**：比赛管理模块
- **notifications**：消息通知模块
- **logs**：日志管理模块

### 2.3 部署架构

```
Internet
    ↓
Nginx (负载均衡 + 静态文件)
    ↓
uWSGI (应用服务器)
    ↓
Django Application
    ↓
MySQL Database
```

---

## 3. 功能需求规格

### 3.1 用户管理功能

#### 3.1.1 用户注册

**功能描述**：支持学员和教练在线注册账户

**输入规格**：
- 用户名：3-20个字符，支持字母、数字、下划线
- 密码：8-20个字符，必须包含字母、数字和特殊字符
- 真实姓名：2-10个中文字符
- 手机号：11位数字，符合中国手机号格式
- 邮箱：符合标准邮箱格式
- 性别：男/女/其他
- 年龄：6-100岁
- 校区：从可用校区列表中选择

**输出规格**：
- 注册成功：返回用户ID和基本信息
- 注册失败：返回具体错误信息

**业务规则**：
- 用户名和手机号全局唯一
- 教练注册需要管理员审核
- 学员注册后自动激活

#### 3.1.2 用户登录

**功能描述**：用户通过用户名/手机号和密码登录系统

**输入规格**：
- 登录标识：用户名或手机号
- 密码：用户设置的密码
- 验证码：图形验证码（可选）

**输出规格**：
- 登录成功：返回用户信息和访问令牌
- 登录失败：返回错误信息

**业务规则**：
- 连续登录失败5次锁定账户30分钟
- 记录登录日志
- 支持记住登录状态

#### 3.1.3 用户资料管理

**功能描述**：用户可以查看和修改个人资料

**可修改字段**：
- 真实姓名、性别、年龄
- 手机号、邮箱
- 头像上传
- 密码修改

**业务规则**：
- 手机号修改需要验证码确认
- 密码修改需要输入原密码
- 头像文件大小限制2MB，支持jpg/png格式

### 3.2 校区管理功能

#### 3.2.1 校区信息管理

**功能描述**：管理校区基本信息和配置

**数据字段**：
- 校区名称、地址、联系方式
- 营业时间、球台数量
- 管理员分配
- 收费标准设置

**业务规则**：
- 每个校区必须指定一名管理员
- 球台编号自动生成且唯一
- 收费标准支持按时段差异化定价

#### 3.2.2 学员管理

**功能描述**：校区管理员管理本校区学员

**管理功能**：
- 查看学员列表和详细信息
- 学员账户状态管理（激活/冻结）
- 学员消费记录查询
- 学员培训进度跟踪

**业务规则**：
- 只能管理本校区学员
- 冻结学员无法进行预约和消费
- 支持按多种条件筛选和搜索

#### 3.2.3 教练管理

**功能描述**：校区管理员管理本校区教练

**管理功能**：
- 教练注册审核
- 教练资质管理
- 教练排课管理
- 教练收入统计

**业务规则**：
- 教练必须通过资质审核才能接受预约
- 教练等级影响课时费标准
- 支持教练请假和调课管理

### 3.3 课程预约功能

#### 3.3.1 师生关系建立

**功能描述**：学员选择教练建立师生关系

**流程规格**：
1. 学员浏览教练列表
2. 查看教练详细信息和评价
3. 提交师生关系申请
4. 教练审核申请
5. 建立师生关系

**业务规则**：
- 学员最多同时选择2名教练
- 教练可设置最大学员数量
- 师生关系建立后才能进行课程预约

#### 3.3.2 课程预约

**功能描述**：学员向已建立关系的教练预约课程

**预约流程**：
1. 选择教练和时间段
2. 系统检查教练可用性和球台资源
3. 计算课程费用
4. 确认预约并扣费
5. 等待教练确认

**输入规格**：
- 教练ID：已建立关系的教练
- 预约日期：当前日期后7天内
- 时间段：30分钟为最小单位
- 课程时长：30分钟、60分钟、90分钟

**业务规则**：
- 预约需要提前至少2小时
- 同一时间段每个教练只能接受一个预约
- 预约成功后立即扣除课程费用
- 24小时内取消预约收取20%手续费

#### 3.3.3 预约管理

**功能描述**：用户管理自己的预约记录

**管理功能**：
- 查看预约历史
- 取消未开始的预约
- 预约时间调整（双方同意）
- 预约状态跟踪

**状态定义**：
- 待确认：等待教练确认
- 已确认：教练已确认，等待上课
- 进行中：课程正在进行
- 已完成：课程正常结束
- 已取消：预约被取消
- 已过期：超时未进行

### 3.4 支付管理功能

#### 3.4.1 账户充值

**功能描述**：学员通过多种方式为账户充值（目前未接入三方平台，微信支付等未实现）

**充值方式**：
- 线下充值：现金、银行转账（需管理员审核）

**业务规则**：
- 单次充值金额：10-5000元
- 充值成功后立即到账
- 充值记录永久保存

#### 3.4.2 消费扣费

**功能描述**：系统自动处理各种消费扣费

**扣费场景**：
- 课程预约费用
- 比赛报名费用
- 取消预约手续费
- 其他服务费用

**扣费规则**：
- 余额不足时无法进行消费
- 扣费成功后立即生成交易记录
- 支持消费明细查询
- 异常扣费支持退款处理

#### 3.4.3 退费管理

**功能描述**：处理各种退费申请

**退费场景**：
- 课程取消退费
- 比赛取消退费
- 账户注销退费
- 其他特殊情况退费

**退费流程**：
1. 用户提交退费申请
2. 管理员审核申请
3. 审核通过后处理退费
4. 退费到原支付账户或用户余额

**业务规则**：
- 退费申请需要说明原因
- 管理员有权拒绝不合理退费
- 退费处理时间：3-7个工作日
- 退费记录永久保存

### 3.5 比赛管理功能

#### 3.5.1 比赛创建

**功能描述**：管理员创建和发布比赛活动

**比赛信息**：
- 比赛名称、描述、规则
- 比赛时间、地点
- 报名费用、报名截止时间
- 参赛人数限制
- 奖项设置

**业务规则**：
- 比赛创建后需要发布才能报名
- 报名截止后不能修改比赛信息
- 支持比赛取消和延期

#### 3.5.2 比赛报名

**功能描述**：学员报名参加比赛

**报名流程**：
1. 查看比赛信息和规则
2. 确认参赛资格
3. 支付报名费用
4. 提交报名申请
5. 等待比赛开始

**报名条件**：
- 账户余额充足
- 在报名截止时间内
- 未达到参赛人数上限
- 符合比赛参赛要求

#### 3.5.3 比赛分组

**功能描述**：系统自动或管理员手动进行比赛分组

**分组规则**：
- 参赛人数≤6人：单组循环赛
- 参赛人数>6人：分组循环赛+淘汰赛
- 分组尽量平衡实力
- 支持手动调整分组

**分组算法**：
- 根据历史比赛成绩
- 考虑年龄和性别因素
- 随机分配保证公平性

#### 3.5.4 赛程管理

**功能描述**：生成和管理比赛赛程

**赛程生成**：
- 自动生成比赛对阵表
- 分配比赛时间和球台
- 考虑参赛者时间冲突
- 支持赛程调整

**赛程通知**：
- 赛程确定后通知参赛者
- 比赛前提醒通知
- 赛程变更及时通知

#### 3.5.5 比赛结果

**功能描述**：记录和管理比赛结果

**结果录入**：
- 支持实时比分录入
- 比赛结果确认机制
- 异议处理流程
- 最终排名生成

**结果公布**：
- 比赛结果实时更新
- 最终排名公示
- 获奖名单发布
- 奖品发放记录

### 3.6 消息通知功能

#### 3.6.1 系统通知

**功能描述**：系统自动发送各类通知消息

**通知类型**：
- 预约确认通知
- 支付成功通知
- 比赛相关通知
- 系统维护通知
- 账户异常通知

**通知渠道**：
- 站内消息
- 短信通知（重要消息）
- 邮件通知（可选）

#### 3.6.2 消息管理

**功能描述**：用户管理接收到的消息

**管理功能**：
- 查看消息列表
- 标记已读/未读
- 删除消息
- 消息搜索
- 通知设置

**消息状态**：
- 未读：新接收的消息
- 已读：用户已查看的消息
- 已删除：用户删除的消息

---
#### 3.7 安全日志
**日志类型**：
- 登录日志：成功/失败记录
- 操作日志：关键操作记录
- 异常日志：系统异常记录
- 安全日志：安全事件记录


## 5. 数据库设计规格

#### 5.1.1 数据库选型

- **主数据库**：MySQL 8.0
- **字符集**：utf8mb4
- **存储引擎**：InnoDB
- **事务隔离级别**：READ COMMITTED

### 5.2 核心数据表设计
见《数据库设计.md》
### 5.3 数据完整性约束

#### 5.3.1 主键约束
- 所有表都有自增主键id
- 主键类型统一使用BIGINT

#### 5.3.2 外键约束
- 所有外键关系都定义了约束
- 删除策略：CASCADE或RESTRICT
- 更新策略：CASCADE

#### 5.3.3 唯一性约束
- 用户名、手机号全局唯一
- 同一时间段教练预约唯一
- 比赛报名用户唯一

#### 5.3.4 检查约束
- 年龄范围：6-100岁
- 金额范围：≥0
- 时间逻辑：结束时间>开始时间

### 5.4 索引设计

#### 5.4.1 主要索引
- 主键索引：所有表的id字段
- 唯一索引：username, phone等唯一字段
- 外键索引：所有外键字段

#### 5.4.2 复合索引
- (coach_id, booking_date, start_time)：预约查询
- (user_id, payment_type, status)：支付查询
- (campus_id, status)：校区相关查询

#### 5.4.3 索引优化策略
- 定期分析索引使用情况
- 删除未使用的索引
- 根据查询模式调整索引

## 6. 接口设计规格

### 6.1 API设计原则

#### 6.1.1 RESTful设计
- 使用标准HTTP方法（GET, POST, PUT, DELETE）
- 资源导向的URL设计
- 统一的响应格式
- 合理的HTTP状态码使用

#### 6.1.2 版本控制
- URL版本控制：/api/v1/
- 向后兼容原则
- 版本废弃通知机制

#### 6.1.3 安全设计
- JWT Token认证
- API访问频率限制
- 输入参数验证
- 输出数据过滤

### 6.2 核心API接口

#### 6.2.1 用户认证接口

**用户登录**
```
POST /api/v1/auth/login/
Content-Type: application/json

Request:
{
    "username": "string",
    "password": "string"
}

Response:
{
    "code": 200,
    "message": "登录成功",
    "data": {
        "token": "jwt_token_string",
        "user": {
            "id": 1,
            "username": "testuser",
            "real_name": "张三",
            "user_type": "student",
            "campus_id": 1
        }
    }
}
```

**用户注册**
```
POST /api/v1/auth/register/
Content-Type: application/json

Request:
{
    "username": "string",
    "password": "string",
    "password_confirm": "string",
    "real_name": "string",
    "phone": "string",
    "email": "string",
    "gender": "M|F|O",
    "age": 25,
    "campus_id": 1,
    "user_type": "student|coach"
}

Response:
{
    "code": 201,
    "message": "注册成功",
    "data": {
        "user_id": 1,
        "username": "testuser"
    }
}
```

#### 6.2.2 预约管理接口

**创建预约**
```
POST /api/v1/bookings/
Authorization: Bearer {token}
Content-Type: application/json

Request:
{
    "coach_id": 2,
    "booking_date": "2024-12-25",
    "start_time": "14:00:00",
    "duration": 60
}

Response:
{
    "code": 201,
    "message": "预约创建成功",
    "data": {
        "booking_id": 1,
        "status": "pending",
        "course_fee": 100.00
    }
}
```

**查询预约列表**
```
GET /api/v1/bookings/?status=confirmed&page=1&page_size=10
Authorization: Bearer {token}

Response:
{
    "code": 200,
    "message": "查询成功",
    "data": {
        "count": 25,
        "next": "/api/v1/bookings/?page=2",
        "previous": null,
        "results": [
            {
                "id": 1,
                "coach_name": "李教练",
                "booking_date": "2024-12-25",
                "start_time": "14:00:00",
                "end_time": "15:00:00",
                "status": "confirmed",
                "course_fee": 100.00
            }
        ]
    }
}
```

#### 6.2.3 支付管理接口

**创建充值订单**
```
POST /api/v1/payments/recharge/
Authorization: Bearer {token}
Content-Type: application/json

Request:
{
    "amount": 500.00,
    "payment_method": "alipay"
}

Response:
{
    "code": 201,
    "message": "充值订单创建成功",
    "data": {
        "payment_id": 1,
        "payment_url": "https://payment.example.com/pay/123",
        "qr_code": "data:image/png;base64,..."
    }
}
```

**查询账户余额**
```
GET /api/v1/accounts/balance/
Authorization: Bearer {token}

Response:
{
    "code": 200,
    "message": "查询成功",
    "data": {
        "balance": 1250.50,
        "total_recharge": 2000.00,
        "total_consumption": 749.50
    }
}
```

#### 6.2.4 比赛管理接口

**查询比赛列表**
```
GET /api/v1/competitions/?status=registration_open&campus_id=1
Authorization: Bearer {token}

Response:
{
    "code": 200,
    "message": "查询成功",
    "data": {
        "results": [
            {
                "id": 1,
                "name": "2024年春季乒乓球比赛",
                "start_date": "2024-12-30",
                "registration_fee": 50.00,
                "registration_deadline": "2024-12-28T18:00:00",
                "max_participants": 32,
                "current_participants": 15,
                "status": "registration_open"
            }
        ]
    }
}
```

**比赛报名**
```
POST /api/v1/competitions/1/register/
Authorization: Bearer {token}

Response:
{
    "code": 201,
    "message": "报名成功",
    "data": {
        "registration_id": 1,
        "competition_name": "2024年春季乒乓球比赛",
        "registration_fee": 50.00
    }
}
```

### 6.3 响应格式规范

#### 6.3.1 成功响应
```json
{
    "code": 200,
    "message": "操作成功",
    "data": {
        // 具体数据
    },
    "timestamp": "2024-12-20T10:30:00Z"
}
```

#### 6.3.2 错误响应
```json
{
    "code": 400,
    "message": "请求参数错误",
    "errors": {
        "username": ["用户名不能为空"],
        "password": ["密码长度至少8位"]
    },
    "timestamp": "2024-12-20T10:30:00Z"
}
```

#### 6.3.3 分页响应
```json
{
    "code": 200,
    "message": "查询成功",
    "data": {
        "count": 100,
        "next": "/api/v1/resource/?page=3",
        "previous": "/api/v1/resource/?page=1",
        "results": [
            // 数据列表
        ]
    }
}
```

### 6.4 错误码定义

| 错误码 | HTTP状态码 | 描述 |
|--------|------------|------|
| 200 | 200 | 操作成功 |
| 201 | 201 | 创建成功 |
| 400 | 400 | 请求参数错误 |
| 401 | 401 | 未授权访问 |
| 403 | 403 | 权限不足 |
| 404 | 404 | 资源不存在 |
| 409 | 409 | 资源冲突 |
| 422 | 422 | 数据验证失败 |
| 429 | 429 | 请求频率超限 |
| 500 | 500 | 服务器内部错误 |

---
## 7. 系统安全规格

#### 7.1 权限控制
**角色权限矩阵**：

| 功能模块 | 学员 | 教练 | 校区管理员 | 超级管理员 |
|----------|------|------|------------|------------|
| 个人信息管理 | ✓ | ✓ | ✓ | ✓ |
| 课程预约 | ✓ | ✓ | ✗ | ✗ |
| 支付管理 | ✓ | ✗ | ✓ | ✓ |
| 比赛管理 | 报名 | 报名 | 全部 | 全部 |
| 用户管理 | ✗ | ✗ | 本校区 | 全部 |
| 系统配置 | ✗ | ✗ | 部分 | 全部 |

**权限实现**：
- 基于Django的权限系统
- 装饰器权限检查
- 中间件权限拦截
- 前端权限控制

#### 7.2 JWT Token管理
**Token配置**：
- 访问Token有效期：2小时
- 刷新Token有效期：7天
- Token加密算法：HS256
- Token包含信息：用户ID、角色、权限

**Token安全**：
- Token存储在HTTP-Only Cookie
- 支持Token黑名单机制
- 异常登录自动撤销Token
- Token定期轮换机制

### 7.3 输入验证与防护
**前端验证**：
- JavaScript实时验证
- 正则表达式验证
- 长度和格式检查
- 特殊字符过滤

**后端验证**：
- Django表单验证
- 序列化器验证
- 数据库约束验证
- 业务逻辑验证

