<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯¾ç¨‹è¡¨APIè°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .button {
            background: #409eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #337ecc;
        }
        .button.danger {
            background: #f56c6c;
        }
        .button.success {
            background: #67c23a;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            background: #fef0f0;
            border-color: #fbc4c4;
            color: #f56c6c;
        }
        .success {
            background: #f0f9ff;
            border-color: #b3d8ff;
            color: #409eff;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            display: inline-block;
            margin: 5px 0;
        }
        .status.online {
            background: #f0f9ff;
            color: #409eff;
        }
        .status.offline {
            background: #fef0f0;
            color: #f56c6c;
        }
    </style>
</head>
<body>
    <h1>ğŸ“ è¯¾ç¨‹è¡¨APIè°ƒè¯•å·¥å…·</h1>
    
    <div class="container">
        <h2>ğŸ“‹ å½“å‰çŠ¶æ€</h2>
        <div id="status">
            <div class="status" id="tokenStatus">TokençŠ¶æ€: æ£€æŸ¥ä¸­...</div>
            <div class="status" id="apiStatus">APIçŠ¶æ€: æ£€æŸ¥ä¸­...</div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ”‘ Tokenç®¡ç†</h2>
        <div class="input-group">
            <label for="tokenInput">è®¾ç½®Token:</label>
            <input type="text" id="tokenInput" placeholder="è¾“å…¥Token" value="d548b083231205ef6d7d8726629a0c9340d34f5d">
        </div>
        <button class="button" onclick="setToken()">è®¾ç½®Token</button>
        <button class="button" onclick="getToken()">è·å–Token</button>
        <button class="button danger" onclick="clearToken()">æ¸…é™¤Token</button>
        <div id="tokenResult" class="result"></div>
    </div>

    <div class="container">
        <h2>ğŸ“… è¯¾ç¨‹è¡¨APIæµ‹è¯•</h2>
        <div class="input-group">
            <label for="dateFrom">å¼€å§‹æ—¥æœŸ:</label>
            <input type="date" id="dateFrom">
        </div>
        <div class="input-group">
            <label for="dateTo">ç»“æŸæ—¥æœŸ:</label>
            <input type="date" id="dateTo">
        </div>
        <button class="button" onclick="testScheduleAPI()">æµ‹è¯•è¯¾ç¨‹è¡¨API</button>
        <button class="button" onclick="testTodaySchedule()">æµ‹è¯•ä»Šæ—¥è¯¾ç¨‹</button>
        <button class="button" onclick="testWeekSchedule()">æµ‹è¯•æœ¬å‘¨è¯¾ç¨‹</button>
        <div id="apiResult" class="result"></div>
    </div>

    <div class="container">
        <h2>ğŸ”§ ç½‘ç»œè¯Šæ–­</h2>
        <button class="button" onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
        <button class="button" onclick="testAuth()">æµ‹è¯•è®¤è¯</button>
        <button class="button" onclick="checkCORS()">æ£€æŸ¥CORS</button>
        <div id="diagnosticResult" class="result"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // é…ç½®axios
        axios.defaults.baseURL = 'http://127.0.0.1:8000';
        axios.defaults.withCredentials = true;

        // åˆå§‹åŒ–é¡µé¢
        window.onload = function() {
            checkStatus();
            setDefaultDates();
        };

        function setDefaultDates() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            
            document.getElementById('dateFrom').value = today.toISOString().split('T')[0];
            document.getElementById('dateTo').value = tomorrow.toISOString().split('T')[0];
        }

        function checkStatus() {
            // æ£€æŸ¥TokençŠ¶æ€
            const token = localStorage.getItem('token');
            const tokenStatus = document.getElementById('tokenStatus');
            if (token) {
                tokenStatus.textContent = `TokençŠ¶æ€: å·²è®¾ç½® (${token.substring(0, 10)}...)`;
                tokenStatus.className = 'status online';
                
                // è®¾ç½®axiosé»˜è®¤å¤´
                axios.defaults.headers.common['Authorization'] = `Token ${token}`;
            } else {
                tokenStatus.textContent = 'TokençŠ¶æ€: æœªè®¾ç½®';
                tokenStatus.className = 'status offline';
            }

            // æ£€æŸ¥APIçŠ¶æ€
            testConnection().then(() => {
                const apiStatus = document.getElementById('apiStatus');
                apiStatus.textContent = 'APIçŠ¶æ€: åœ¨çº¿';
                apiStatus.className = 'status online';
            }).catch(() => {
                const apiStatus = document.getElementById('apiStatus');
                apiStatus.textContent = 'APIçŠ¶æ€: ç¦»çº¿';
                apiStatus.className = 'status offline';
            });
        }

        function setToken() {
            const token = document.getElementById('tokenInput').value.trim();
            if (token) {
                localStorage.setItem('token', token);
                axios.defaults.headers.common['Authorization'] = `Token ${token}`;
                document.getElementById('tokenResult').textContent = `âœ… Tokenå·²è®¾ç½®: ${token}`;
                document.getElementById('tokenResult').className = 'result success';
                checkStatus();
            } else {
                document.getElementById('tokenResult').textContent = 'âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„Token';
                document.getElementById('tokenResult').className = 'result error';
            }
        }

        function getToken() {
            const token = localStorage.getItem('token');
            const result = document.getElementById('tokenResult');
            if (token) {
                result.textContent = `å½“å‰Token: ${token}`;
                result.className = 'result success';
            } else {
                result.textContent = 'æœªæ‰¾åˆ°Token';
                result.className = 'result error';
            }
        }

        function clearToken() {
            localStorage.removeItem('token');
            delete axios.defaults.headers.common['Authorization'];
            document.getElementById('tokenResult').textContent = 'âœ… Tokenå·²æ¸…é™¤';
            document.getElementById('tokenResult').className = 'result success';
            checkStatus();
        }

        async function testScheduleAPI() {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const result = document.getElementById('apiResult');
            
            try {
                result.textContent = 'ğŸ”„ æ­£åœ¨è°ƒç”¨API...';
                result.className = 'result';
                
                const params = {};
                if (dateFrom) params.date_from = dateFrom;
                if (dateTo) params.date_to = dateTo;
                
                console.log('å‘é€è¯·æ±‚:', {
                    url: '/api/reservations/bookings/my_schedule/',
                    params: params,
                    headers: axios.defaults.headers.common
                });
                
                const response = await axios.get('/api/reservations/bookings/my_schedule/', { params });
                
                result.textContent = `âœ… APIè°ƒç”¨æˆåŠŸ!\n\nçŠ¶æ€ç : ${response.status}\n\nå“åº”æ•°æ®:\n${JSON.stringify(response.data, null, 2)}`;
                result.className = 'result success';
                
                console.log('APIå“åº”:', response);
                
            } catch (error) {
                console.error('APIè°ƒç”¨å¤±è´¥:', error);
                
                let errorMsg = `âŒ APIè°ƒç”¨å¤±è´¥!\n\n`;
                errorMsg += `é”™è¯¯ç±»å‹: ${error.name}\n`;
                errorMsg += `é”™è¯¯ä¿¡æ¯: ${error.message}\n`;
                
                if (error.response) {
                    errorMsg += `çŠ¶æ€ç : ${error.response.status}\n`;
                    errorMsg += `å“åº”æ•°æ®: ${JSON.stringify(error.response.data, null, 2)}\n`;
                } else if (error.request) {
                    errorMsg += `è¯·æ±‚å·²å‘é€ä½†æ— å“åº”\n`;
                    errorMsg += `è¯·æ±‚è¯¦æƒ…: ${error.request}\n`;
                } else {
                    errorMsg += `è¯·æ±‚é…ç½®é”™è¯¯: ${error.config}\n`;
                }
                
                result.textContent = errorMsg;
                result.className = 'result error';
            }
        }

        async function testTodaySchedule() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFrom').value = today;
            document.getElementById('dateTo').value = today;
            await testScheduleAPI();
        }

        async function testWeekSchedule() {
            const today = new Date();
            const monday = new Date(today);
            monday.setDate(today.getDate() - today.getDay() + 1);
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            
            document.getElementById('dateFrom').value = monday.toISOString().split('T')[0];
            document.getElementById('dateTo').value = sunday.toISOString().split('T')[0];
            await testScheduleAPI();
        }

        async function testConnection() {
            const result = document.getElementById('diagnosticResult');
            try {
                result.textContent = 'ğŸ”„ æµ‹è¯•è¿æ¥...';
                result.className = 'result';
                
                const response = await axios.get('/api/');
                result.textContent = `âœ… è¿æ¥æˆåŠŸ!\nçŠ¶æ€ç : ${response.status}`;
                result.className = 'result success';
                return Promise.resolve();
            } catch (error) {
                result.textContent = `âŒ è¿æ¥å¤±è´¥!\né”™è¯¯: ${error.message}`;
                result.className = 'result error';
                return Promise.reject(error);
            }
        }

        async function testAuth() {
            const result = document.getElementById('diagnosticResult');
            try {
                result.textContent = 'ğŸ”„ æµ‹è¯•è®¤è¯...';
                result.className = 'result';
                
                const response = await axios.get('/api/accounts/profile/');
                result.textContent = `âœ… è®¤è¯æˆåŠŸ!\nç”¨æˆ·ä¿¡æ¯: ${JSON.stringify(response.data, null, 2)}`;
                result.className = 'result success';
            } catch (error) {
                result.textContent = `âŒ è®¤è¯å¤±è´¥!\nçŠ¶æ€ç : ${error.response?.status}\né”™è¯¯: ${error.response?.data?.message || error.message}`;
                result.className = 'result error';
            }
        }

        async function checkCORS() {
            const result = document.getElementById('diagnosticResult');
            result.textContent = `ğŸ” CORSæ£€æŸ¥:\n\nå½“å‰åŸŸå: ${window.location.origin}\nAPIåœ°å€: ${axios.defaults.baseURL}\nwithCredentials: ${axios.defaults.withCredentials}\n\nè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰CORSé”™è¯¯`;
            result.className = 'result';
        }

        // ç›‘å¬axiosè¯·æ±‚å’Œå“åº”
        axios.interceptors.request.use(request => {
            console.log('ğŸš€ å‘é€è¯·æ±‚:', request);
            return request;
        });

        axios.interceptors.response.use(
            response => {
                console.log('âœ… æ”¶åˆ°å“åº”:', response);
                return response;
            },
            error => {
                console.error('âŒ è¯·æ±‚é”™è¯¯:', error);
                return Promise.reject(error);
            }
        );
    </script>
</body>
</html>