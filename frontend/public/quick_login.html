<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«é€Ÿç™»å½•æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .section h3 {
            margin-top: 0;
            color: #555;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
        }
        button:hover {
            background: #005a87;
        }
        .success {
            background: #28a745;
        }
        .success:hover {
            background: #218838;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 13px;
            max-height: 200px;
            overflow-y: auto;
        }
        .success-result {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error-result {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info-result {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .link {
            display: inline-block;
            margin: 10px;
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 6px;
        }
        .link:hover {
            background: #5a6268;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ å¿«é€Ÿç™»å½•æµ‹è¯•</h1>
        
        <div class="section">
            <h3>1. å¿«é€Ÿè®¾ç½®è®¤è¯</h3>
            <p>ä½¿ç”¨é¢„è®¾çš„tokenå¿«é€Ÿè®¾ç½®è®¤è¯çŠ¶æ€ï¼Œè·³è¿‡ç™»å½•æµç¨‹ã€‚</p>
            <button onclick="quickSetAuth()" class="success">å¿«é€Ÿè®¾ç½®è®¤è¯</button>
            <button onclick="checkAuthStatus()">æ£€æŸ¥è®¤è¯çŠ¶æ€</button>
            <button onclick="clearAuth()">æ¸…é™¤è®¤è¯</button>
            <div id="authResult" class="result"></div>
        </div>
        
        <div class="section">
            <h3>2. æµ‹è¯•APIè°ƒç”¨</h3>
            <p>æµ‹è¯•å„ä¸ªAPIç«¯ç‚¹æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>
            <button onclick="testAllAPIs()">æµ‹è¯•æ‰€æœ‰API</button>
            <button onclick="testStatsAPI()">æµ‹è¯•ç»Ÿè®¡API</button>
            <button onclick="testNotificationsAPI()">æµ‹è¯•é€šçŸ¥API</button>
            <div id="apiResult" class="result"></div>
        </div>
        
        <div class="section">
            <h3>3. è·³è½¬åˆ°ä¸»åº”ç”¨</h3>
            <p>è®¾ç½®è®¤è¯åï¼Œå¯ä»¥è·³è½¬åˆ°ä¸»åº”ç”¨æµ‹è¯•ã€‚</p>
            <a href="http://localhost:3001" class="link" target="_blank">æ‰“å¼€ä¸»åº”ç”¨</a>
            <a href="http://localhost:3001/dashboard" class="link" target="_blank">æ‰“å¼€Dashboard</a>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000';
        const TEST_TOKEN = '2f4e9746ba1c15900dd4df0858e5dd67a099a79e';
        
        function quickSetAuth() {
            try {
                // è®¾ç½®token
                localStorage.setItem('token', TEST_TOKEN);
                
                // æ¨¡æ‹Ÿç”¨æˆ·ä¿¡æ¯ï¼ˆæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼‰
                const mockUser = {
                    id: 1,
                    username: 'testuser',
                    real_name: 'æµ‹è¯•ç”¨æˆ·',
                    user_type: 'student',
                    email: 'test@example.com',
                    avatar: null
                };
                
                // è®¾ç½®ç”¨æˆ·ä¿¡æ¯åˆ°localStorageï¼ˆæ¨¡æ‹ŸPinia storeï¼‰
                localStorage.setItem('user', JSON.stringify(mockUser));
                
                showResult('authResult', 'âœ… è®¤è¯è®¾ç½®æˆåŠŸï¼\n' + 
                    `Token: ${TEST_TOKEN.substring(0, 20)}...\n` + 
                    `ç”¨æˆ·: ${mockUser.username} (${mockUser.real_name})`, 'success-result');
                    
            } catch (error) {
                showResult('authResult', `âŒ è®¾ç½®è®¤è¯å¤±è´¥: ${error.message}`, 'error-result');
            }
        }
        
        function checkAuthStatus() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            let status = 'è®¤è¯çŠ¶æ€æ£€æŸ¥:\n';
            
            if (token) {
                status += `âœ… Token: ${token.substring(0, 20)}...\n`;
            } else {
                status += 'âŒ æœªè®¾ç½®Token\n';
            }
            
            if (user) {
                try {
                    const userObj = JSON.parse(user);
                    status += `âœ… ç”¨æˆ·: ${userObj.username} (${userObj.real_name})\n`;
                } catch (e) {
                    status += 'âŒ ç”¨æˆ·ä¿¡æ¯æ ¼å¼é”™è¯¯\n';
                }
            } else {
                status += 'âŒ æœªè®¾ç½®ç”¨æˆ·ä¿¡æ¯\n';
            }
            
            const resultClass = (token && user) ? 'success-result' : 'error-result';
            showResult('authResult', status, resultClass);
        }
        
        function clearAuth() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            showResult('authResult', 'ğŸ—‘ï¸ è®¤è¯ä¿¡æ¯å·²æ¸…é™¤', 'info-result');
        }
        
        async function testStatsAPI() {
            showResult('apiResult', 'æ­£åœ¨æµ‹è¯•ç»Ÿè®¡API...', 'info-result');
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showResult('apiResult', 'âŒ æœªè®¾ç½®Tokenï¼Œè¯·å…ˆè®¾ç½®è®¤è¯', 'error-result');
                    return;
                }
                
                const response = await fetch(`${API_BASE}/accounts/api/stats/`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                const responseText = await response.text();
                console.log('ç»Ÿè®¡APIå“åº”:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    showResult('apiResult', `âŒ ç»Ÿè®¡APIå“åº”ä¸æ˜¯æœ‰æ•ˆJSON:\nçŠ¶æ€ç : ${response.status}\nå“åº”: ${responseText}`, 'error-result');
                    return;
                }
                
                const message = `${response.ok ? 'âœ…' : 'âŒ'} ç»Ÿè®¡API\nçŠ¶æ€ç : ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}`;
                showResult('apiResult', message, response.ok ? 'success-result' : 'error-result');
                
            } catch (error) {
                showResult('apiResult', `âŒ ç»Ÿè®¡APIé”™è¯¯: ${error.message}`, 'error-result');
            }
        }
        
        async function testNotificationsAPI() {
            showResult('apiResult', 'æ­£åœ¨æµ‹è¯•é€šçŸ¥API...', 'info-result');
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showResult('apiResult', 'âŒ æœªè®¾ç½®Tokenï¼Œè¯·å…ˆè®¾ç½®è®¤è¯', 'error-result');
                    return;
                }
                
                const response = await fetch(`${API_BASE}/api/notifications/list/?page=1&page_size=5`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                const responseText = await response.text();
                console.log('é€šçŸ¥APIå“åº”:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    showResult('apiResult', `âŒ é€šçŸ¥APIå“åº”ä¸æ˜¯æœ‰æ•ˆJSON:\nçŠ¶æ€ç : ${response.status}\nå“åº”: ${responseText}`, 'error-result');
                    return;
                }
                
                const message = `${response.ok ? 'âœ…' : 'âŒ'} é€šçŸ¥API\nçŠ¶æ€ç : ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}`;
                showResult('apiResult', message, response.ok ? 'success-result' : 'error-result');
                
            } catch (error) {
                showResult('apiResult', `âŒ é€šçŸ¥APIé”™è¯¯: ${error.message}`, 'error-result');
            }
        }
        
        async function testAllAPIs() {
            showResult('apiResult', 'æ­£åœ¨æµ‹è¯•æ‰€æœ‰API...', 'info-result');
            
            const token = localStorage.getItem('token');
            if (!token) {
                showResult('apiResult', 'âŒ æœªè®¾ç½®Tokenï¼Œè¯·å…ˆè®¾ç½®è®¤è¯', 'error-result');
                return;
            }
            
            const apis = [
                { name: 'ç»Ÿè®¡API', url: '/accounts/api/stats/' },
                { name: 'é€šçŸ¥åˆ—è¡¨API', url: '/api/notifications/list/?page=1&page_size=5' },
                { name: 'æœªè¯»æ¶ˆæ¯API', url: '/api/notifications/unread-count/' },
                { name: 'ç”¨æˆ·èµ„æ–™API', url: '/accounts/api/profile/' }
            ];
            
            let results = 'æ‰€æœ‰APIæµ‹è¯•ç»“æœ:\n\n';
            
            for (const api of apis) {
                try {
                    const response = await fetch(`${API_BASE}${api.url}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });
                    
                    const status = response.ok ? 'âœ…' : 'âŒ';
                    results += `${status} ${api.name}: ${response.status}\n`;
                    
                } catch (error) {
                    results += `âŒ ${api.name}: é”™è¯¯ - ${error.message}\n`;
                }
            }
            
            showResult('apiResult', results, 'info-result');
        }
        
        function showResult(elementId, message, className) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${className}`;
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥è®¤è¯çŠ¶æ€
        window.onload = function() {
            checkAuthStatus();
            console.log('å¿«é€Ÿç™»å½•æµ‹è¯•é¡µé¢å·²åŠ è½½');
        };
    </script>
</body>
</html>