<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤´åƒå’ŒæŒ‰é’®è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .avatar-test {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .avatar-test img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 15px;
            border: 2px solid #ddd;
        }
        .avatar-info {
            flex: 1;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>å¤´åƒæ˜¾ç¤ºå’ŒæŒ‰é’®çŠ¶æ€è°ƒè¯•å·¥å…·</h1>
        
        <div class="section">
            <h3>ğŸ” é—®é¢˜è¯Šæ–­</h3>
            <button onclick="runFullDiagnosis()">å¼€å§‹å®Œæ•´è¯Šæ–­</button>
            <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="diagnosis-log" class="log-area"></div>
        </div>

        <div class="section">
            <h3>ğŸ–¼ï¸ å¤´åƒURLæµ‹è¯•</h3>
            <div id="avatar-tests"></div>
        </div>

        <div class="section">
            <h3>ğŸ”˜ æŒ‰é’®çŠ¶æ€æµ‹è¯•</h3>
            <div id="button-tests"></div>
        </div>

        <div class="section">
            <h3>ğŸ“¡ APIå“åº”æµ‹è¯•</h3>
            <button onclick="testCoachesAPI()">æµ‹è¯•æ•™ç»ƒåˆ—è¡¨API</button>
            <button onclick="testRelationsAPI()">æµ‹è¯•å¸ˆç”Ÿå…³ç³»API</button>
            <div id="api-results"></div>
        </div>

        <div class="section">
            <h3>ğŸŒ ç½‘ç»œè¯·æ±‚ç›‘æ§</h3>
            <button onclick="startNetworkMonitoring()">å¼€å§‹ç›‘æ§</button>
            <button onclick="stopNetworkMonitoring()">åœæ­¢ç›‘æ§</button>
            <div id="network-log" class="log-area"></div>
        </div>
    </div>

    <script>
        let logArea = null;
        let networkMonitoring = false;
        let originalFetch = null;

        function log(message, type = 'info') {
            if (!logArea) logArea = document.getElementById('diagnosis-log');
            const timestamp = new Date().toLocaleTimeString();
            const statusIcon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
            logArea.textContent += `[${timestamp}] ${statusIcon} ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        function clearLogs() {
            document.getElementById('diagnosis-log').textContent = '';
            document.getElementById('network-log').textContent = '';
        }

        async function runFullDiagnosis() {
            log('å¼€å§‹å®Œæ•´è¯Šæ–­...', 'info');
            
            // 1. æ£€æŸ¥åŸºç¡€ç¯å¢ƒ
            await checkEnvironment();
            
            // 2. æµ‹è¯•å¤´åƒURL
            await testAvatarUrls();
            
            // 3. æµ‹è¯•APIå“åº”
            await testAPIs();
            
            // 4. æ£€æŸ¥å‰ç«¯çŠ¶æ€
            await checkFrontendState();
            
            log('è¯Šæ–­å®Œæˆï¼', 'success');
        }

        async function checkEnvironment() {
            log('æ£€æŸ¥åŸºç¡€ç¯å¢ƒ...', 'info');
            
            // æ£€æŸ¥å½“å‰é¡µé¢URL
            log(`å½“å‰é¡µé¢: ${window.location.href}`);
            
            // æ£€æŸ¥localStorageä¸­çš„token
            const token = localStorage.getItem('token');
            log(`è®¤è¯Token: ${token ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}`);
            
            // æ£€æŸ¥ç½‘ç»œè¿æ¥
            try {
                const response = await fetch('http://localhost:8000/api/accounts/profile/', {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });
                log(`åç«¯è¿æ¥: ${response.ok ? 'æ­£å¸¸' : 'å¼‚å¸¸'} (çŠ¶æ€ç : ${response.status})`);
            } catch (error) {
                log(`åç«¯è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testAvatarUrls() {
            log('æµ‹è¯•å¤´åƒURL...', 'info');
            
            const testUrls = [
                '/media/avatars/avatar_4_8f901e9d.jpg',
                'http://127.0.0.1:8000/media/avatars/avatar_4_8f901e9d.jpg',
                'http://localhost:3001/media/avatars/avatar_4_8f901e9d.jpg',
                '/default-avatar.svg'
            ];

            const avatarContainer = document.getElementById('avatar-tests');
            avatarContainer.innerHTML = '';

            for (const url of testUrls) {
                const testDiv = document.createElement('div');
                testDiv.className = 'avatar-test';
                
                const img = document.createElement('img');
                img.src = url;
                
                const info = document.createElement('div');
                info.className = 'avatar-info';
                info.innerHTML = `<strong>URL:</strong> ${url}<br><span id="status-${testUrls.indexOf(url)}">æµ‹è¯•ä¸­...</span>`;
                
                testDiv.appendChild(img);
                testDiv.appendChild(info);
                avatarContainer.appendChild(testDiv);

                // æµ‹è¯•å›¾ç‰‡åŠ è½½
                img.onload = () => {
                    document.getElementById(`status-${testUrls.indexOf(url)}`).innerHTML = 
                        '<span class="status-indicator status-success"></span>åŠ è½½æˆåŠŸ';
                    log(`å¤´åƒåŠ è½½æˆåŠŸ: ${url}`, 'success');
                };
                
                img.onerror = () => {
                    document.getElementById(`status-${testUrls.indexOf(url)}`).innerHTML = 
                        '<span class="status-indicator status-error"></span>åŠ è½½å¤±è´¥';
                    log(`å¤´åƒåŠ è½½å¤±è´¥: ${url}`, 'error');
                };
            }
        }

        async function testCoachesAPI() {
            log('æµ‹è¯•æ•™ç»ƒåˆ—è¡¨API...', 'info');
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('http://localhost:8000/api/accounts/coaches/', {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });
                
                const data = await response.json();
                log(`æ•™ç»ƒåˆ—è¡¨APIå“åº”: ${response.status}`);
                log(`å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}`);
                
                if (data.results && data.results.length > 0) {
                    const firstCoach = data.results[0];
                    log(`ç¬¬ä¸€ä¸ªæ•™ç»ƒæ•°æ®: ${JSON.stringify(firstCoach, null, 2)}`);
                    
                    if (firstCoach.user && firstCoach.user.avatar) {
                        log(`æ•™ç»ƒå¤´åƒå­—æ®µ: ${firstCoach.user.avatar}`, 'success');
                    } else {
                        log('æ•™ç»ƒæ•°æ®ä¸­æ²¡æœ‰å¤´åƒå­—æ®µ', 'error');
                    }
                }
                
                document.getElementById('api-results').innerHTML = 
                    `<div class="test-result success">æ•™ç»ƒåˆ—è¡¨APIæµ‹è¯•å®Œæˆï¼Œè¯¦è§æ—¥å¿—</div>`;
                    
            } catch (error) {
                log(`æ•™ç»ƒåˆ—è¡¨APIæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('api-results').innerHTML = 
                    `<div class="test-result error">æ•™ç»ƒåˆ—è¡¨APIæµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function testRelationsAPI() {
            log('æµ‹è¯•å¸ˆç”Ÿå…³ç³»API...', 'info');
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('http://localhost:8000/api/reservations/relations/', {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });
                
                const data = await response.json();
                log(`å¸ˆç”Ÿå…³ç³»APIå“åº”: ${response.status}`);
                log(`å…³ç³»æ•°æ®: ${JSON.stringify(data, null, 2)}`);
                
                document.getElementById('api-results').innerHTML += 
                    `<div class="test-result success">å¸ˆç”Ÿå…³ç³»APIæµ‹è¯•å®Œæˆï¼Œè¯¦è§æ—¥å¿—</div>`;
                    
            } catch (error) {
                log(`å¸ˆç”Ÿå…³ç³»APIæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('api-results').innerHTML += 
                    `<div class="test-result error">å¸ˆç”Ÿå…³ç³»APIæµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function testAPIs() {
            await testCoachesAPI();
            await testRelationsAPI();
        }

        async function checkFrontendState() {
            log('æ£€æŸ¥å‰ç«¯çŠ¶æ€...', 'info');
            
            // æ£€æŸ¥Vueåº”ç”¨çŠ¶æ€ï¼ˆå¦‚æœå¯è®¿é—®ï¼‰
            if (window.Vue) {
                log('Vueæ¡†æ¶å·²åŠ è½½', 'success');
            } else {
                log('Vueæ¡†æ¶æœªæ£€æµ‹åˆ°', 'warning');
            }
            
            // æ£€æŸ¥Element Plus
            if (window.ElementPlus) {
                log('Element Pluså·²åŠ è½½', 'success');
            } else {
                log('Element Plusæœªæ£€æµ‹åˆ°', 'warning');
            }
        }

        function startNetworkMonitoring() {
            if (networkMonitoring) return;
            
            networkMonitoring = true;
            const networkLog = document.getElementById('network-log');
            
            // ç›‘æ§fetchè¯·æ±‚
            originalFetch = window.fetch;
            window.fetch = function(...args) {
                const url = args[0];
                const options = args[1] || {};
                
                networkLog.textContent += `[${new Date().toLocaleTimeString()}] ğŸŒ Fetch: ${url}\n`;
                networkLog.scrollTop = networkLog.scrollHeight;
                
                return originalFetch.apply(this, args)
                    .then(response => {
                        networkLog.textContent += `[${new Date().toLocaleTimeString()}] âœ… Response: ${response.status} ${url}\n`;
                        networkLog.scrollTop = networkLog.scrollHeight;
                        return response;
                    })
                    .catch(error => {
                        networkLog.textContent += `[${new Date().toLocaleTimeString()}] âŒ Error: ${error.message} ${url}\n`;
                        networkLog.scrollTop = networkLog.scrollHeight;
                        throw error;
                    });
            };
            
            log('ç½‘ç»œç›‘æ§å·²å¯åŠ¨', 'success');
        }

        function stopNetworkMonitoring() {
            if (!networkMonitoring) return;
            
            networkMonitoring = false;
            if (originalFetch) {
                window.fetch = originalFetch;
            }
            
            log('ç½‘ç»œç›‘æ§å·²åœæ­¢', 'info');
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨å¼€å§‹è¯Šæ–­
        window.addEventListener('load', () => {
            log('è°ƒè¯•å·¥å…·å·²åŠ è½½', 'success');
        });
    </script>
</body>
</html>