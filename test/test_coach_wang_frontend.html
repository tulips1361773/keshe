<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>王教练课表测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .login-form { background: #f5f5f5; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
        .schedule { background: #fff; border: 1px solid #ddd; border-radius: 5px; padding: 20px; }
        .booking-item { background: #e8f4fd; margin: 10px 0; padding: 15px; border-radius: 5px; border-left: 4px solid #007bff; }
        .error { color: red; background: #ffe6e6; padding: 10px; border-radius: 5px; }
        .success { color: green; background: #e6ffe6; padding: 10px; border-radius: 5px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>王教练课表测试页面</h1>
        
        <div class="login-form">
            <h3>登录测试</h3>
            <input type="text" id="username" placeholder="用户名" value="王教练">
            <input type="password" id="password" placeholder="密码" value="password123">
            <button onclick="login()">登录</button>
            <div id="loginResult"></div>
        </div>
        
        <div class="schedule">
            <h3>课表数据</h3>
            <button onclick="loadSchedule()">加载王教练课表</button>
            <div id="scheduleResult"></div>
        </div>
    </div>

    <script>
        let authToken = null;
        
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('loginResult');
            
            try {
                const response = await fetch('http://localhost:8000/api/accounts/login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.access) {
                    authToken = data.access;
                    resultDiv.innerHTML = `<div class="success">✓ 登录成功！用户: ${data.user.real_name} (${data.user.user_type})</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error">✗ 登录失败: ${data.message || '未知错误'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">✗ 网络错误: ${error.message}</div>`;
            }
        }
        
        async function loadSchedule() {
            const resultDiv = document.getElementById('scheduleResult');
            
            if (!authToken) {
                resultDiv.innerHTML = '<div class="error">请先登录</div>';
                return;
            }
            
            try {
                const today = new Date().toISOString().split('T')[0];
                const nextWeek = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                
                const response = await fetch(`http://localhost:8000/api/reservations/bookings/?date_from=${today}&date_to=${nextWeek}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const wangBookings = data.results.filter(booking => 
                        booking.relation.coach.real_name === '王教练'
                    );
                    
                    if (wangBookings.length > 0) {
                        let html = `<div class="success">✓ 找到 ${wangBookings.length} 个王教练的预约</div>`;
                        wangBookings.forEach(booking => {
                            const startTime = new Date(booking.start_time).toLocaleString('zh-CN');
                            const endTime = new Date(booking.end_time).toLocaleString('zh-CN', { 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            });
                            html += `
                                <div class="booking-item">
                                    <strong>${startTime} - ${endTime}</strong><br>
                                    学生: ${booking.relation.student.real_name}<br>
                                    球台: ${booking.table.name} (${booking.table.number})<br>
                                    状态: ${booking.status}<br>
                                    费用: ¥${booking.total_fee}<br>
                                    时长: ${booking.duration_hours}小时<br>
                                    ${booking.notes ? `备注: ${booking.notes}` : ''}
                                </div>
                            `;
                        });
                        resultDiv.innerHTML = html;
                    } else {
                        resultDiv.innerHTML = '<div class="error">没有找到王教练的预约数据</div>';
                    }
                } else {
                    resultDiv.innerHTML = `<div class="error">✗ 加载失败: ${data.detail || data.message || '未知错误'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">✗ 网络错误: ${error.message}</div>`;
            }
        }
        
        // 页面加载时自动尝试登录
        window.onload = function() {
            login();
        };
    </script>
</body>
</html>