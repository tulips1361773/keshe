<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试前端取消预约</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
    <h1>测试前端取消预约功能</h1>
    <div id="result"></div>
    
    <script>
        // 配置axios
        axios.defaults.baseURL = 'http://127.0.0.1:8000';
        
        // 设置认证头
        const token = '6fb923aed3ee0f867797a87e0139d825d0dd9937'; // 从测试中获取的token
        axios.defaults.headers.common['Authorization'] = `Token ${token}`;
        
        async function testCancelBooking() {
            const resultDiv = document.getElementById('result');
            
            try {
                // 1. 获取取消统计
                console.log('1. 获取取消统计');
                const statsResponse = await axios.get('/api/reservations/bookings/cancel_stats/');
                console.log('取消统计:', statsResponse.data);
                
                resultDiv.innerHTML += `<p><strong>取消统计:</strong> ${JSON.stringify(statsResponse.data, null, 2)}</p>`;
                
                // 2. 尝试取消预约
                console.log('2. 尝试取消预约 ID: 37');
                const cancelResponse = await axios.post('/api/reservations/bookings/37/cancel/', {
                    reason: '测试取消原因'
                });
                
                console.log('取消成功:', cancelResponse.data);
                resultDiv.innerHTML += `<p><strong>取消成功:</strong> ${JSON.stringify(cancelResponse.data, null, 2)}</p>`;
                
            } catch (error) {
                console.error('取消预约错误:', error);
                
                if (error.response) {
                    const errorMessage = error.response.data?.error || '取消预约失败';
                    console.log('错误信息:', errorMessage);
                    console.log('状态码:', error.response.status);
                    console.log('完整响应:', error.response.data);
                    
                    resultDiv.innerHTML += `<p style="color: red;"><strong>错误:</strong> ${errorMessage}</p>`;
                    resultDiv.innerHTML += `<p><strong>状态码:</strong> ${error.response.status}</p>`;
                    resultDiv.innerHTML += `<p><strong>完整响应:</strong> ${JSON.stringify(error.response.data, null, 2)}</p>`;
                } else {
                    resultDiv.innerHTML += `<p style="color: red;"><strong>网络错误:</strong> ${error.message}</p>`;
                }
            }
        }
        
        // 页面加载后自动测试
        window.onload = testCancelBooking;
    </script>
</body>
</html>