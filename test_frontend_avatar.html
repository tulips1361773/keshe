<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前端头像显示测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-title {
            color: #333;
            border-bottom: 2px solid #409eff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .avatar-test {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .avatar-img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 15px;
            border: 2px solid #ddd;
        }
        .avatar-info {
            flex: 1;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.success { background: #f0f9ff; color: #1890ff; }
        .status.error { background: #fff2f0; color: #ff4d4f; }
        .log-area {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        button {
            background: #409eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #66b1ff;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h2 class="test-title">前端头像显示测试</h2>
        
        <div class="avatar-test">
            <img id="avatar1" class="avatar-img" src="" alt="头像1" onerror="handleImageError(this, '直接URL测试')">
            <div class="avatar-info">
                <strong>测试1: 直接URL</strong><br>
                <span id="status1" class="status">等待测试</span><br>
                <small id="url1">URL: 未设置</small>
            </div>
        </div>
        
        <div class="avatar-test">
            <img id="avatar2" class="avatar-img" src="" alt="头像2" onerror="handleImageError(this, '相对路径测试')">
            <div class="avatar-info">
                <strong>测试2: 相对路径拼接</strong><br>
                <span id="status2" class="status">等待测试</span><br>
                <small id="url2">URL: 未设置</small>
            </div>
        </div>
        
        <div class="avatar-test">
            <img id="avatar3" class="avatar-img" src="" alt="头像3" onerror="handleImageError(this, '模拟API响应')">
            <div class="avatar-info">
                <strong>测试3: 模拟API响应</strong><br>
                <span id="status3" class="status">等待测试</span><br>
                <small id="url3">URL: 未设置</small>
            </div>
        </div>
        
        <div style="margin: 20px 0;">
            <button onclick="testDirectUrl()">测试直接URL</button>
            <button onclick="testRelativePath()">测试相对路径</button>
            <button onclick="testApiResponse()">测试API响应</button>
            <button onclick="clearLog()">清空日志</button>
        </div>
    </div>
    
    <div class="test-container">
        <h3>测试日志</h3>
        <div id="log" class="log-area">等待开始测试...\n</div>
    </div>

    <script>
        function log(message) {
            const logArea = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logArea.textContent += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function updateStatus(testId, status, url) {
            const statusEl = document.getElementById(`status${testId}`);
            const urlEl = document.getElementById(`url${testId}`);
            
            statusEl.textContent = status;
            statusEl.className = `status ${status.includes('成功') ? 'success' : 'error'}`;
            urlEl.textContent = `URL: ${url}`;
        }
        
        function handleImageError(img, testName) {
            log(`${testName} - 图片加载失败: ${img.src}`);
            const testId = img.id.replace('avatar', '');
            updateStatus(testId, '加载失败', img.src);
        }
        
        function handleImageLoad(img, testName) {
            log(`${testName} - 图片加载成功: ${img.src}`);
            const testId = img.id.replace('avatar', '');
            updateStatus(testId, '加载成功', img.src);
        }
        
        function testDirectUrl() {
            log('开始测试1: 直接URL');
            const img = document.getElementById('avatar1');
            const url = 'http://localhost:8000/media/avatars/avatar_4_8f901e9d.jpg';
            
            img.onload = () => handleImageLoad(img, '直接URL测试');
            img.onerror = () => handleImageError(img, '直接URL测试');
            img.src = url;
            
            updateStatus(1, '加载中...', url);
            log(`设置图片URL: ${url}`);
        }
        
        function testRelativePath() {
            log('开始测试2: 相对路径拼接');
            const img = document.getElementById('avatar2');
            const relativePath = '/media/avatars/avatar_4_8f901e9d.jpg';
            const fullUrl = `http://localhost:8000${relativePath}`;
            
            img.onload = () => handleImageLoad(img, '相对路径测试');
            img.onerror = () => handleImageError(img, '相对路径测试');
            img.src = fullUrl;
            
            updateStatus(2, '加载中...', fullUrl);
            log(`相对路径: ${relativePath}`);
            log(`拼接完整URL: ${fullUrl}`);
        }
        
        async function testApiResponse() {
            log('开始测试3: 模拟API响应');
            
            try {
                // 模拟获取CSRF token
                const csrfResponse = await fetch('http://127.0.0.1:8000/api/accounts/csrf-token/');
                const csrfData = await csrfResponse.json();
                log(`CSRF Token获取: ${csrfResponse.ok ? '成功' : '失败'}`);
                log(`CSRF Token: ${csrfData.csrfToken ? csrfData.csrfToken.substring(0, 20) + '...' : 'None'}`);
                
                if (!csrfResponse.ok) {
                    log(`CSRF Token获取失败: ${csrfResponse.status} ${csrfResponse.statusText}`);
                    updateStatus(3, 'CSRF获取失败', csrfResponse.status);
                    return;
                }
                
                // 模拟登录
                const loginResponse = await fetch('http://127.0.0.1:8000/api/accounts/login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfData.csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        username: 'hhm',
                        password: '123456'
                    })
                });
                
                log(`登录请求: ${loginResponse.ok ? '成功' : '失败'} (${loginResponse.status})`);
                
                if (!loginResponse.ok) {
                    const loginError = await loginResponse.text();
                    log(`登录失败详情: ${loginError}`);
                    updateStatus(3, '登录失败', loginResponse.status);
                    return;
                }
                
                const loginData = await loginResponse.json();
                log(`登录响应: ${JSON.stringify(loginData, null, 2)}`);
                
                // 获取用户资料
                const profileResponse = await fetch('http://127.0.0.1:8000/api/accounts/profile/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfData.csrfToken,
                        'Authorization': `Token ${loginData.token}`
                    },
                    credentials: 'include'
                });
                
                log(`Profile API请求: ${profileResponse.ok ? '成功' : '失败'} (${profileResponse.status})`);
                
                if (!profileResponse.ok) {
                    const profileError = await profileResponse.text();
                    log(`Profile API失败详情: ${profileError}`);
                    updateStatus(3, 'Profile API失败', profileResponse.status);
                    return;
                }
                
                const profileData = await profileResponse.json();
                log(`API响应数据: ${JSON.stringify(profileData, null, 2)}`);
                
                const avatar = profileData.user?.avatar;
                log(`头像字段: ${avatar}`);
                
                if (avatar) {
                    const img = document.getElementById('avatar3');
                    let avatarUrl = avatar;
                    
                    // 模拟前端getAvatarUrl函数逻辑
                    if (!avatar.startsWith('http')) {
                        avatarUrl = `http://localhost:8000${avatar}`;
                        log(`拼接完整URL: ${avatarUrl}`);
                    }
                    
                    img.onload = () => handleImageLoad(img, '模拟API响应');
                    img.onerror = () => handleImageError(img, '模拟API响应');
                    img.src = avatarUrl;
                    
                    updateStatus(3, '加载中...', avatarUrl);
                } else {
                    log('API响应中没有头像字段');
                    updateStatus(3, '无头像数据', 'N/A');
                }
                
            } catch (error) {
                log(`API测试异常: ${error.message}`);
                log(`异常堆栈: ${error.stack}`);
                updateStatus(3, '测试异常', error.message);
            }
        }
        
        function clearLog() {
            document.getElementById('log').textContent = '日志已清空...\n';
        }
        
        // 页面加载完成后的初始化
        window.onload = function() {
            log('页面加载完成，准备开始测试');
            log('请点击按钮开始各项测试');
        };
    </script>
</body>
</html>